import{G as m,$ as o,I as g,T as C,C as d,V as P,L as T,ai as D,a0 as B,D as x,a8 as U}from"./DarkTheme-gFe2bpMP.js";import{B as E}from"./Clipboard-MYtz7jaA.js";import{g as F}from"./generate_filename-BifgnS-c.js";import{B as R}from"./BuildApi-CKOZHWrf.js";import{C as r}from"./main-DZWrXasQ.js";import{i as O}from"./connection-ByZId8Xf.js";const f={lineDelayMs:5,profileSwitchDelayMs:100,outputHistory:"",cliBuffer:"",startProcessing:!1,GUI:{snippetPreviewWindow:null,copyButton:null,windowWrapper:null},lastArrival:0};function G(t){return t.replace(/^# /,"")}function _(t,e){let n=0;for(let i=0;i<e.length&&t[i]===e[i];i++)n++;return e.length-n}function H(t,e,n){return"".repeat(n)+t.substring(e.length-n,t.length)}function S(t,e){const n=G(e),i=new RegExp(`^${n}`,"g");if(t.match(i))return t.replace(i,"");const c=_(t,n);return H(t,n,c)}function M(t){function e(){x.sendEvent(x.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"CliCopyToClipboard",{length:t.length});const i=C.cli.GUI.copyButton,c=i.text(),h=i.css("width");i.text(g.getMessage("cliCopySuccessful")),i.css({width:h,textAlign:"center"}),setTimeout(()=>{i.text(c),i.css({width:"",textAlign:""})},1500)}function n(i){console.warn(i)}E.writeText(t,e,n)}f.initialize=function(t){const e=this;m.active_tab!=="cli"&&(m.active_tab="cli"),e.outputHistory="",e.cliBuffer="",e.startProcessing=!1;const n=13;function i(){e.outputHistory="",e.GUI.windowWrapper.empty()}async function c(s){e.history.add(s.trim());function a(u){let p=u.shift().trim(),w=e.lineDelayMs;p.toLowerCase().startsWith("profile")&&(w=e.profileSwitchDelayMs);const b=l.length===0;b&&e.cliBuffer&&(p=S(p,e.cliBuffer)),e.sendLine(p),b||m.timeout_add("CLI_send_slowly",function(){a(u)},w)}const l=s.split(`
`);a(l)}async function h(){const s=o("#snippetpreviewcontent textarea#preview");function a(p){const w=s.val();x.sendEvent(x.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"CliExecuteFromFile",{filename:p}),c(w),e.GUI.snippetPreviewWindow.close()}function l(p,w){e.GUI.snippetPreviewWindow||(e.GUI.snippetPreviewWindow=new U("Modal",{id:"snippetPreviewWindow",width:"auto",height:"auto",closeButton:"title",animation:!1,isolateScroll:!1,title:g.getMessage("cliConfirmSnippetDialogTitle",{fileName:w}),content:o("#snippetpreviewcontent"),onCreated:()=>o("#snippetpreviewcontent a.confirm").click(()=>a(w))})),s.val(p),e.GUI.snippetPreviewWindow.open()}const u=await B.pickOpenFile(g.getMessage("fileSystemPickerFiles",{typeof:"TXT"}),".txt"),y=await B.readFile(u);l(y,u.name)}async function k(s,a){const l=await B.pickSaveFile(s,g.getMessage("fileSystemPickerFiles",{typeof:"TXT"}),".txt");await B.writeFile(l,a)}o("#content").load("./tabs/cli.html",function(){g.localizePage(),C.cli.adaptPhones(),d.cliActive=!0,e.GUI.copyButton=o("a.copy"),e.GUI.windowWrapper=o(".tab-cli .window .wrapper");const s=o('.tab-cli textarea[name="commands"]');r.initialize(s,e.sendLine.bind(e),v),o(r).on("build:start",function(){s.val("").attr("placeholder",g.getMessage("cliInputPlaceholderBuilding")).prop("disabled",!0)}),o(r).on("build:stop",function(){s.attr("placeholder",g.getMessage("cliInputPlaceholder")).prop("disabled",!1).focus()}),o("a.save").on("click",function(){const a=F("cli","txt");k(a,e.outputHistory)}),o("a.clear").click(function(){i()}),e.GUI.copyButton.click(function(){M(e.outputHistory)}),o("a.load").on("click",function(){h()}),o("a.support").toggle(O()).on("click",function(){function a(l){i();const u=new R;u.getSupportCommands(async y=>{y=[`###
# Problem description
# ${l}
###`,...y],await c(y.join(`
`));const p=setInterval(()=>{const w=new Date().getTime();if(e.lastArrival<w-250){clearInterval(p);const b=e.outputHistory;u.submitSupportData(b,L=>{v(g.getMessage("buildServerSupportRequestSubmission",[L]))})}},250)})}e.supportWarningDialog(a)}),s.keydown(function(a){if(a.which===9)if(a.preventDefault(),r.isEnabled())!r.isOpen()&&!r.isBuilding()&&r.openLater(!0);else{const y=s.val().split(`
`).pop(),p=S(y,e.cliBuffer);p&&(e.sendNativeAutoComplete(p),s.val(""))}}),s.keypress(function(a){if(a.which===n){if(a.preventDefault(),r.isBuilding())return;const l=s.val();c(l),s.val("")}}),s.keyup(function(a){const l={38:!0},u={40:!0};r.isOpen()||(a.keyCode in l&&s.val(e.history.prev()),a.keyCode in u&&s.val(e.history.next()))}),s.focus(),m.timeout_add("enter_cli",function(){const l=new ArrayBuffer(1),u=new Uint8Array(l);u[0]=35,P.send(l)},250),m.content_ready(t)})};f.adaptPhones=function(){if(o(window).width()<575){const t=o(".note").height()+22+38;o(".backdrop").css("height",`calc(100% - ${t}px)`)}};f.history={history:[],index:0};f.history.add=function(t){this.history.push(t),this.index=this.history.length};f.history.prev=function(){return this.index>0&&(this.index-=1),this.history[this.index]};f.history.next=function(){return this.index<this.history.length&&(this.index+=1),this.history[this.index-1]};const V=8,A=10,I=13;function v(t){C.cli.GUI.windowWrapper.append(t);const e=o(".tab-cli .window");e.scrollTop(e.prop("scrollHeight"))}function W(t){if(r.isBuilding()){r.builderParseLine(t);return}t.startsWith("###ERROR")?v(`<span class="error_message">${t}</span><br>`):v(`${t}<br>`)}function $(t){o(".tab-cli textarea").val(t)}f.read=function(t){const e=new Uint8Array(t.data??t);let n="",i=0;for(let c=0;c<e.length;c++){const h=String.fromCharCode(e[c]),k=h.charCodeAt()===A||h.charCodeAt()===I;if(!d.cliValid&&(k||this.startProcessing)){this.startProcessing=!0,n+=h,v(h);continue}if(e[c]===27&&!i&&(i=3),i){i--;continue}if(d.cliValid)switch(e[c]){case A:m.operating_system==="Windows"&&(W(this.cliBuffer),this.cliBuffer="");break;case I:m.operating_system!=="Windows"&&(W(this.cliBuffer),this.cliBuffer="");break;case 60:this.cliBuffer+="&lt";break;case 62:this.cliBuffer+="&gt";break;case V:this.cliBuffer=this.cliBuffer.slice(0,-1),this.outputHistory=this.outputHistory.slice(0,-1);continue;default:this.cliBuffer+=h}r.isBuilding()||(this.outputHistory+=h),this.cliBuffer==="Rebooting"&&(d.cliActive=!1,d.cliValid=!1,T(g.getMessage("cliReboot")),D())}if(this.lastArrival=new Date().getTime(),!d.cliValid&&n.indexOf("CLI")!==-1){T(g.getMessage("cliEnter")),d.cliValid=!0;const c=n.split(`
`).pop();this.outputHistory=c,r.isEnabled()&&!r.isBuilding()&&r.builderStart()}r.isEnabled()||$(G(this.cliBuffer))};f.sendLine=function(t,e){this.send(`${t}
`,e)};f.sendNativeAutoComplete=function(t,e){this.send(`${t}	`,e)};f.send=function(t,e){const n=new ArrayBuffer(t.length),i=new Uint8Array(n);for(let c=0;c<t.length;c++)i[c]=t.charCodeAt(c);P.send(n,e)};f.supportWarningDialog=function(t){const e=o(".supportWarningDialog")[0],n=o('.tab-cli textarea[name="supportWarningDialogInput"]');e.hasAttribute("open")||(e.showModal(),o(".cancel").on("click",function(){e.close()}),o(".submit").on("click",function(){e.close(),t(n.val()),n.val("")}))};f.cleanup=function(t){if(C.cli.GUI.snippetPreviewWindow&&(C.cli.GUI.snippetPreviewWindow.destroy(),C.cli.GUI.snippetPreviewWindow=null),!(d.connectionValid&&d.cliValid&&d.cliActive)){t&&t();return}this.send(S("exit\r",this.cliBuffer),function(){D()}),d.cliActive=!1,d.cliValid=!1,r.cleanup(),o(r).off()};C.cli=f;export{f as cli};
