import{F as t,$ as e,H as L,a5 as Xe,M as y,X as u,a3 as K,G as Re,a2 as k,T as Ue,I as E,L as Se,D as je,a9 as it}from"./DarkTheme-BPZSaX8v.js";import{i as rt,M as at,a as nt}from"./main-Cf_tRlY7.js";import{R as lt}from"./RateCurve-p4TYFB_r.js";import{i as Be,d as $e}from"./common-CGdis4Xk.js";const Je={redWhiteGreen:[{percentage:-1,color:{r:255,g:0,b:0,a:1}},{percentage:0,color:{r:255,g:255,b:255,a:1}},{percentage:1,color:{r:0,g:255,b:0,a:1}}],pidSlider:[{percentage:-1,color:{r:197,g:197,b:197,a:1}},{percentage:0,color:{r:255,g:255,b:255,a:0}},{percentage:1,color:{r:255,g:84,b:14,a:1}}]};function st(r,i=null){i=i||Je.redWhiteGreen,r=Math.min(1,Math.max(-1,r));let o;for(o=1;o<i.length-1&&!(r<i[o].percentage);o++);const c=i[o-1],g=i[o],n=g.percentage-c.percentage,T=(r-c.percentage)/n,_=1-T,p=T,R={r:Math.floor(c.color.r*_+g.color.r*p),g:Math.floor(c.color.g*_+g.color.g*p),b:Math.floor(c.color.b*_+g.color.b*p),a:c.color.a*_+g.color.a*p};return`rgba(${[R.r,R.g,R.b,R.a].join(",")})`}const s={sliderPidsMode:2,sliderDGain:1,sliderPIGain:1,sliderFeedforwardGain:1,sliderDMaxGain:1,sliderIGain:1,sliderRollPitchRatio:1,sliderPitchPIGain:1,sliderMasterMultiplier:1,pidSlidersUnavailable:!1,GyroSliderUnavailable:!1,DTermSliderUnavailable:!1,sliderGyroFilter:1,sliderGyroFilterMultiplier:1,sliderDTermFilter:1,sliderDTermFilterMultiplier:1,dMaxFeatureEnabled:!0,defaultPDRatio:0,PID_DEFAULT:[],FILTER_DEFAULT:{},SLIDER_DEFAULT:{},NON_EXPERT_SLIDER_MIN:70,NON_EXPERT_SLIDER_MAX:140,NON_EXPERT_SLIDER_MIN_GYRO:50,NON_EXPERT_SLIDER_MAX_GYRO:150,NON_EXPERT_SLIDER_MIN_DTERM:80,NON_EXPERT_SLIDER_MAX_DTERM:120,cachedPidSliderValues:!1,cachedGyroSliderValues:!1,cachedDTermSliderValues:!1,expertMode:!1};s.initialize=function(){this.PID_DEFAULT=t.getPidDefaults(),this.FILTER_DEFAULT=t.getFilterDefaults(),this.SLIDER_DEFAULT=t.getSliderDefaults(),this.setExpertMode(rt()),this.cachedPidSliderValues=!1,this.cachedGyroSliderValues=!1,this.cachedDTermSliderValues=!1,this.initPidSlidersPosition(),this.initGyroFilterSliderPosition(),this.initDTermFilterSliderPosition(),this.validateTuningSliders(),this.updatePidSlidersDisplay(),this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay(),this.updateFilterSlidersWarning(),e(".subtab-pid .slidersDisabled").hide(),e(".subtab-filter .slidersDisabled").hide()};s.updateExpertModePidSlidersDisplay=function(){const r=t.TUNING_SLIDERS.slider_d_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_d_gain>this.NON_EXPERT_SLIDER_MAX,i=t.TUNING_SLIDERS.slider_pi_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_pi_gain>this.NON_EXPERT_SLIDER_MAX,o=t.TUNING_SLIDERS.slider_feedforward_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_feedforward_gain>this.NON_EXPERT_SLIDER_MAX,c=t.TUNING_SLIDERS.slider_dmax_gain!==t.DEFAULT_TUNING_SLIDERS.slider_dmax_gain,g=t.TUNING_SLIDERS.slider_i_gain!==t.DEFAULT_TUNING_SLIDERS.slider_i_gain,n=t.TUNING_SLIDERS.slider_roll_pitch_ratio!==t.DEFAULT_TUNING_SLIDERS.slider_roll_pitch_ratio,T=t.TUNING_SLIDERS.slider_pitch_pi_gain!==t.DEFAULT_TUNING_SLIDERS.slider_pitch_pi_gain,_=t.TUNING_SLIDERS.slider_master_multiplier!==t.DEFAULT_TUNING_SLIDERS.slider_master_multiplier,p=r||i||o,R=c||g||n||T||_;e(".baseSliderDGain").toggleClass("disabledSliders",!this.sliderPidsMode||r&&!this.expertMode),e(".baseSliderPIGain").toggleClass("disabledSliders",!this.sliderPidsMode||i&&!this.expertMode),e(".baseSliderFeedforwardGain").toggleClass("disabledSliders",!this.sliderPidsMode||o&&!this.expertMode),e(".advancedSlider").toggleClass("disabledSliders",!this.sliderPidsMode||!this.expertMode),e(".advancedSliderDmaxGain").toggle(c||this.expertMode),e(".advancedSliderIGain").toggle(g||this.expertMode),e(".advancedSliderRollPitchRatio").toggle(n||this.expertMode),e(".advancedSliderPitchPIGain").toggle(T||this.expertMode),e(".advancedSliderMaster").toggle(_||this.expertMode),e("#sliderDGain").prop("disabled",!this.sliderPidsMode||r&&!this.expertMode),e("#sliderPIGain").prop("disabled",!this.sliderPidsMode||i&&!this.expertMode),e("#sliderFeedforwardGain").prop("disabled",!this.sliderPidsMode||o&&!this.expertMode),e("#sliderDMaxGain").prop("disabled",!this.sliderPidsMode||c&&!this.expertMode),e("#sliderIGain").prop("disabled",!this.sliderPidsMode||g&&!this.expertMode),e("#sliderRollPitchRatio").prop("disabled",!this.sliderPidsMode||n&&!this.expertMode),e("#sliderPitchPIGain").prop("disabled",!this.sliderPidsMode||T&&!this.expertMode),e("#sliderMasterMultiplier").prop("disabled",!this.sliderPidsMode||_&&!this.expertMode),e(".subtab-pid .expertSettingsDetectedNote").toggle(!this.sliderPidsMode||(p||R)&&!this.expertMode)};s.updateExpertModeFilterSlidersDisplay=function(){const r=(t.TUNING_SLIDERS.slider_gyro_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_GYRO||t.TUNING_SLIDERS.slider_gyro_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_GYRO)&&!this.expertMode,i=(t.TUNING_SLIDERS.slider_dterm_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_DTERM||t.TUNING_SLIDERS.slider_dterm_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_DTERM)&&!this.expertMode,o=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),c=e('.pid_filter input[name="gyroLowpassFrequency"]'),g=e('.pid_filter input[name="gyroLowpass2Frequency"]'),n=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),T=e('.pid_filter input[name="dtermLowpassFrequency"]'),_=e('.pid_filter input[name="dtermLowpass2Frequency"]'),p=parseInt(o.val())===0&&parseInt(c.val())===0&&parseInt(g.val())===0,R=parseInt(n.val())===0&&parseInt(T.val())===0&&parseInt(_.val())===0,M=!this.sliderGyroFilter||r||p,F=!this.sliderDTermFilter||i||R;e(".sliderGyroFilter").toggleClass("disabledSliders",M),e(".sliderDTermFilter").toggleClass("disabledSliders",F),e("#sliderGyroFilterMultiplier").prop("disabled",M),e("#sliderDTermFilterMultiplier").prop("disabled",F),e(".subtab-filter .expertSettingsDetectedNote").toggle(r||i)};s.setExpertMode=function(r){this.expertMode=r,this.updateExpertModePidSlidersDisplay(),this.updateExpertModeFilterSlidersDisplay(),e(".tab-pid_tuning .legacySlider").hide(),e(".legacyNonExpertModeSlidersNote").hide(),e(".subtab-pid .nonExpertModeSlidersNote").toggle(!this.pidSlidersUnavailable&&!this.expertMode),e(".subtab-filter .nonExpertModeSlidersNote").toggle((!this.GyroSliderUnavailable||!this.DTermSliderUnavailable)&&!this.expertMode)};s.scaleSliderValue=function(r){return r>1?Math.round(((r-1)*2+1)*10)/10:r};s.downscaleSliderValue=function(r){return r>1?(r-1)/2+1:r};s.initPidSlidersPosition=function(){this.sliderPidsMode=t.TUNING_SLIDERS.slider_pids_mode,this.sliderDGain=t.TUNING_SLIDERS.slider_d_gain/100,this.sliderPIGain=t.TUNING_SLIDERS.slider_pi_gain/100,this.sliderFeedforwardGain=t.TUNING_SLIDERS.slider_feedforward_gain/100,this.sliderDMaxGain=t.TUNING_SLIDERS.slider_dmax_gain/100,this.sliderIGain=t.TUNING_SLIDERS.slider_i_gain/100,this.sliderRollPitchRatio=t.TUNING_SLIDERS.slider_roll_pitch_ratio/100,this.sliderPitchPIGain=t.TUNING_SLIDERS.slider_pitch_pi_gain/100,this.sliderMasterMultiplier=t.TUNING_SLIDERS.slider_master_multiplier/100,e('output[name="sliderDGain-number"]').val(this.sliderDGain),e('output[name="sliderPIGain-number"]').val(this.sliderPIGain),e('output[name="sliderFeedforwardGain-number"]').val(this.sliderFeedforwardGain),e('output[name="sliderDMaxGain-number"]').val(this.sliderDMaxGain),e('output[name="sliderIGain-number"]').val(this.sliderIGain),e('output[name="sliderRollPitchRatio-number"]').val(this.sliderRollPitchRatio),e('output[name="sliderPitchPIGain-number"]').val(this.sliderPitchPIGain),e('output[name="sliderMasterMultiplier-number"]').val(this.sliderMasterMultiplier),e("#sliderDGain").val(this.sliderDGain),e("#sliderPIGain").val(this.sliderPIGain),e("#sliderFeedforwardGain").val(this.sliderFeedforwardGain),e("#sliderDMaxGain").val(this.sliderDMaxGain),e("#sliderIGain").val(this.sliderIGain),e("#sliderRollPitchRatio").val(this.sliderRollPitchRatio),e("#sliderPitchPIGain").val(this.sliderPitchPIGain),e("#sliderMasterMultiplier").val(this.sliderMasterMultiplier)};s.initGyroFilterSliderPosition=function(){this.sliderGyroFilter=t.TUNING_SLIDERS.slider_gyro_filter,this.sliderGyroFilterMultiplier=t.TUNING_SLIDERS.slider_gyro_filter_multiplier/100,e("#sliderGyroFilterMultiplier").val(this.sliderGyroFilterMultiplier),e('output[name="sliderGyroFilterMultiplier-number"]').val(this.sliderGyroFilterMultiplier)};s.initDTermFilterSliderPosition=function(){this.sliderDTermFilter=t.TUNING_SLIDERS.slider_dterm_filter,this.sliderDTermFilterMultiplier=t.TUNING_SLIDERS.slider_dterm_filter_multiplier/100,e("#sliderDTermFilterMultiplier").val(this.sliderDTermFilterMultiplier),e('output[name="sliderDTermFilterMultiplier-number"]').val(this.sliderDTermFilterMultiplier)};s.gyroFilterSliderEnable=function(){this.sliderGyroFilter=1,this.calculateNewGyroFilters()};s.dtermFilterSliderEnable=function(){this.sliderDTermFilter=1,this.calculateNewDTermFilters()};s.gyroFilterSliderDisable=function(){t.TUNING_SLIDERS.slider_gyro_filter=0,this.updateGyroFilterSliderDisplay()};s.dtermFilterSliderDisable=function(){t.TUNING_SLIDERS.slider_dterm_filter=0,this.updateDTermFilterSliderDisplay()};s.updateSlidersWarning=function(r=!1){const c=2.5*t.PIDS[0][0],g=42,n=L.lt(t.CONFIG.apiVersion,Xe)?t.PIDS[0][0]>70||t.PIDS[0][1]>c||t.PIDS[0][2]>60||t.ADVANCED_TUNING.dMaxRoll>g:t.PIDS[0][0]>70||t.PIDS[0][1]>c||t.PIDS[0][2]>g||t.ADVANCED_TUNING.dMaxRoll>60;e(".subtab-pid .slidersWarning").toggle(n&&!r)};s.updateFilterSlidersWarning=function(){e(".subtab-filter .slidersWarning").toggle(this.sliderGyroFilterMultiplier>=1.55||this.sliderGyroFilterMultiplier<=.45||this.sliderDTermFilterMultiplier>=1.25||this.sliderDTermFilterMultiplier<=.75)};s.updatePidSlidersDisplay=function(){e("#pid_main .ROLL .pid_data input, #pid_main .PITCH .pid_data input").each((r,i)=>e(i).prop("disabled",this.sliderPidsMode>0)),e("#pid_main .YAW .pid_data input").each((r,i)=>e(i).prop("disabled",this.sliderPidsMode===2)),this.updateExpertModePidSlidersDisplay(),e("#sliderPidsModeSelect").val(this.sliderPidsMode),this.updateSlidersWarning(this.pidSlidersUnavailable)};s.updateGyroFilterSliderDisplay=function(){const r=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),i=e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]'),o=e('.pid_filter input[name="gyroLowpassFrequency"]'),c=e('.pid_filter input[name="gyroLowpass2Frequency"]'),g=(t.TUNING_SLIDERS.slider_gyro_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_GYRO||t.TUNING_SLIDERS.slider_gyro_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_GYRO)&&!this.expertMode;t.TUNING_SLIDERS.slider_gyro_filter===0?(this.GyroSliderUnavailable=!0,this.sliderGyroFilter=0):(this.GyroSliderUnavailable=!1,this.sliderGyroFilter=1,this.cachedGyroSliderValues=!0),r.val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz).prop("disabled",this.sliderGyroFilter),i.val(t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz).prop("disabled",this.sliderGyroFilter),o.val(t.FILTER_CONFIG.gyro_lowpass_hz).prop("disabled",this.sliderGyroFilter),c.val(t.FILTER_CONFIG.gyro_lowpass2_hz).prop("disabled",this.sliderGyroFilter),e('output[name="sliderGyroFilterMultiplier-number"]').val(this.sliderGyroFilterMultiplier);const T=t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz===0&&t.FILTER_CONFIG.gyro_lowpass_hz===0&&t.FILTER_CONFIG.gyro_lowpass2_hz===0||g||this.GyroSliderUnavailable;e('select[id="sliderGyroFilterModeSelect"]').val(this.sliderGyroFilter),e(".sliderGyroFilter").toggleClass("disabledSliders",T),e('input[id="sliderGyroFilterMultiplier"]').prop("disabled",T),this.updateFilterSlidersWarning()};s.updateDTermFilterSliderDisplay=function(){const r=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),i=e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]'),o=e('.pid_filter input[name="dtermLowpassFrequency"]'),c=e('.pid_filter input[name="dtermLowpass2Frequency"]'),g=(t.TUNING_SLIDERS.slider_dterm_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_DTERM||t.TUNING_SLIDERS.slider_dterm_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_DTERM)&&!this.expertMode;t.TUNING_SLIDERS.slider_dterm_filter===0?(this.DTermSliderUnavailable=!0,this.sliderDTermFilter=0):(this.DTermSliderUnavailable=!1,this.sliderDTermFilter=1,this.cachedDTermSliderValues=!0),r.val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz).prop("disabled",this.sliderDTermFilter),i.val(t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz).prop("disabled",this.sliderDTermFilter),o.val(t.FILTER_CONFIG.dterm_lowpass_hz).prop("disabled",this.sliderDTermFilter),c.val(t.FILTER_CONFIG.dterm_lowpass2_hz).prop("disabled",this.sliderDTermFilter);const T=t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz===0&&t.FILTER_CONFIG.dterm_lowpass_hz===0&&t.FILTER_CONFIG.dterm_lowpass2_hz===0||g||this.DTermSliderUnavailable;e('output[name="sliderDTermFilterMultiplier-number"]').val(this.sliderDTermFilterMultiplier),e('select[id="sliderDTermFilterModeSelect"]').val(this.sliderDTermFilter),e(".sliderDTermFilter").toggleClass("disabledSliders",T),e('input[id="sliderDTermFilterMultiplier"]').prop("disabled",T),this.updateFilterSlidersWarning()};s.updateFilterSlidersDisplay=function(){this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay(),e(".subtab-filter .nonExpertModeSlidersNote").toggle((!this.GyroSliderUnavailable||!this.DTermSliderUnavailable)&&!this.expertMode)};s.updateFormPids=function(r=!1){r||(t.PID_NAMES.forEach(function(i,o){e(`.pid_tuning .${i} input`).each(function(g){o<3&&g<3&&e(this).val(t.PIDS[o][g])})}),e('.pid_tuning input[name="dMaxRoll"]').val(t.ADVANCED_TUNING.dMaxRoll),e('.pid_tuning input[name="dMaxPitch"]').val(t.ADVANCED_TUNING.dMaxPitch),e('.pid_tuning input[name="dMaxYaw"]').val(t.ADVANCED_TUNING.dMaxYaw),e('.pid_tuning .ROLL input[name="f"]').val(t.ADVANCED_TUNING.feedforwardRoll),e('.pid_tuning .PITCH input[name="f"]').val(t.ADVANCED_TUNING.feedforwardPitch),e('.pid_tuning .YAW input[name="f"]').val(t.ADVANCED_TUNING.feedforwardYaw)),e('output[name="sliderDGain-number"]').val(this.sliderDGain),e('output[name="sliderPIGain-number"]').val(this.sliderPIGain),e('output[name="sliderFeedforwardGain-number"]').val(this.sliderFeedforwardGain),e('output[name="sliderDMaxGain-number"]').val(this.sliderDMaxGain),e('output[name="sliderIGain-number"]').val(this.sliderIGain),e('output[name="sliderRollPitchRatio-number"]').val(this.sliderRollPitchRatio),e('output[name="sliderPitchPIGain-number"]').val(this.sliderPitchPIGain),e('output[name="sliderMasterMultiplier-number"]').val(this.sliderMasterMultiplier),this.updateSlidersWarning()};s.calculateNewPids=function(r=!1){t.TUNING_SLIDERS.slider_pids_mode=this.sliderPidsMode,t.TUNING_SLIDERS.slider_d_gain=Math.round(this.sliderDGain*20)*5,t.TUNING_SLIDERS.slider_pi_gain=Math.round(this.sliderPIGain*20)*5,t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(this.sliderFeedforwardGain*20)*5,t.TUNING_SLIDERS.slider_dmax_gain=Math.round(this.sliderDMaxGain*20)*5,t.TUNING_SLIDERS.slider_i_gain=Math.round(this.sliderIGain*20)*5,t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(this.sliderRollPitchRatio*20)*5,t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(this.sliderPitchPIGain*20)*5,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(this.sliderMasterMultiplier*20)*5,this.readSimplifiedPids()};s.calculateNewGyroFilters=function(){this.readSimplifiedGyroFilters()};s.calculateNewDTermFilters=function(){this.readSimplifiedDTermFilters()};s.readSimplifiedPids=function(r=!1){t.TUNING_SLIDERS.slider_pids_mode=this.sliderPidsMode,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(this.sliderMasterMultiplier*100),t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(this.sliderRollPitchRatio*100),t.TUNING_SLIDERS.slider_i_gain=Math.round(this.sliderIGain*100),t.TUNING_SLIDERS.slider_d_gain=Math.round(this.sliderDGain*100),t.TUNING_SLIDERS.slider_pi_gain=Math.round(this.sliderPIGain*100),t.TUNING_SLIDERS.slider_dmax_gain=Math.round(this.sliderDMaxGain*100),t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(this.sliderFeedforwardGain*100),t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(this.sliderPitchPIGain*100),y.promise(u.MSP_CALCULATE_SIMPLIFIED_PID,K.crunch(u.MSP_CALCULATE_SIMPLIFIED_PID)).then(()=>this.updateFormPids(r))};s.readSimplifiedGyroFilters=function(){t.TUNING_SLIDERS.slider_gyro_filter=this.sliderGyroFilter,t.TUNING_SLIDERS.slider_gyro_filter_multiplier=this.sliderGyroFilterMultiplier*100,t.FILTER_CONFIG.gyro_lowpass_hz=parseInt(e('.pid_filter input[name="gyroLowpassFrequency"]').val()),t.FILTER_CONFIG.gyro_lowpass2_hz=parseInt(e('.pid_filter input[name="gyroLowpass2Frequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val()),y.promise(u.MSP_CALCULATE_SIMPLIFIED_GYRO,K.crunch(u.MSP_CALCULATE_SIMPLIFIED_GYRO)).then(()=>this.updateGyroFilterSliderDisplay())};s.readSimplifiedDTermFilters=function(){t.TUNING_SLIDERS.slider_dterm_filter=this.sliderDTermFilter,t.TUNING_SLIDERS.slider_dterm_filter_multiplier=this.sliderDTermFilterMultiplier*100,t.FILTER_CONFIG.dterm_lowpass_hz=parseInt(e('.pid_filter input[name="dtermLowpassFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass2_hz=parseInt(e('.pid_filter input[name="dtermLowpass2Frequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val()),y.promise(u.MSP_CALCULATE_SIMPLIFIED_DTERM,K.crunch(u.MSP_CALCULATE_SIMPLIFIED_DTERM)).then(()=>this.updateDTermFilterSliderDisplay())};s.validateTuningSliders=function(){y.promise(u.MSP_VALIDATE_SIMPLIFIED_TUNING).then(()=>{this.sliderPidsMode=t.TUNING_SLIDERS.slider_pids_valid>0?t.TUNING_SLIDERS.slider_pids_mode:0,this.sliderGyroFilter=t.TUNING_SLIDERS.slider_gyro_valid,this.sliderDTermFilter=t.TUNING_SLIDERS.slider_dterm_valid,t.TUNING_SLIDERS.slider_pids_mode=t.TUNING_SLIDERS.slider_pids_valid?t.TUNING_SLIDERS.slider_pids_mode:0,t.TUNING_SLIDERS.slider_gyro_filter=t.TUNING_SLIDERS.slider_gyro_valid?t.TUNING_SLIDERS.slider_gyro_filter:0,t.TUNING_SLIDERS.slider_dterm_filter=t.TUNING_SLIDERS.slider_dterm_valid?t.TUNING_SLIDERS.slider_dterm_filter:0,e("#sliderPidsModeSelect").val(this.sliderPidsMode),e("#sliderGyroFilterModeSelect").val(this.sliderGyroFilter),e("#sliderDTermFilterModeSelect").val(this.sliderDTermFilter),this.updatePidSlidersDisplay(),this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay()})};const A={RATE_PROFILE_MASK:128,showAllPids:!1,updating:!0,dirty:!1,previousFilterDynQ:null,previousFilterDynCount:null,currentProfile:null,currentRateProfile:null,currentRatesType:null,previousRatesType:null,SETPOINT_WEIGHT_RANGE_LOW:2.55,SETPOINT_WEIGHT_RANGE_HIGH:20,SETPOINT_WEIGHT_RANGE_LEGACY:2.54,activeSubtab:"pid",analyticsChanges:{},CONFIGURATOR_PIDS:[],CONFIGURATOR_ADVANCED_TUNING:{},CONFIGURATOR_FILTER_CONFIG:{},CONFIGURATOR_RC_TUNING:{},CONFIGURATOR_FEATURE_CONFIG:{},CONFIGURATOR_TUNING_SLIDERS:{}};A.initialize=function(r){const i=this;Re.active_tab!=="pid_tuning"&&(Re.active_tab="pid_tuning",i.activeSubtab="pid");const o=t.getFilterDefaults();y.promise(u.MSP_PID_CONTROLLER).then(()=>y.promise(u.MSP_PIDNAMES)).then(()=>y.promise(u.MSP_PID)).then(()=>y.promise(u.MSP_PID_ADVANCED)).then(()=>y.promise(u.MSP_RC_TUNING)).then(()=>y.promise(u.MSP_FILTER_CONFIG)).then(()=>y.promise(u.MSP_RC_DEADBAND)).then(()=>y.promise(u.MSP_MOTOR_CONFIG)).then(()=>L.gte(t.CONFIG.apiVersion,k)?y.promise(u.MSP2_GET_TEXT,K.crunch(u.MSP2_GET_TEXT,u.PID_PROFILE_NAME)):!0).then(()=>L.gte(t.CONFIG.apiVersion,k)?y.promise(u.MSP2_GET_TEXT,K.crunch(u.MSP2_GET_TEXT,u.RATE_PROFILE_NAME)):!0).then(()=>y.promise(u.MSP_SIMPLIFIED_TUNING)).then(()=>y.promise(u.MSP_ADVANCED_CONFIG)).then(()=>y.send_message(u.MSP_MIXER_CONFIG,!1,!1,c));function c(){e("#content").load("./tabs/pid_tuning.html",pe)}const g=!1;function n(){i.setProfile(),i.setRateProfile(),L.gte(t.CONFIG.apiVersion,k)?(e('input[name="pidProfileName"]').val(t.CONFIG.pidProfileNames[t.CONFIG.profile]),e('input[name="rateProfileName"]').val(t.CONFIG.rateProfileNames[t.CONFIG.rateProfile])):e(".profile_name").hide(),t.PID_NAMES.forEach(function(l,N){e(`.pid_tuning .${l} input`).each((b,D)=>{t.PIDS[N][b]!==void 0&&e(D).val(t.PIDS_ACTIVE[N][b])})}),e('.pid_tuning input[name="rc_rate"]').val(t.RC_TUNING.RC_RATE.toFixed(2)),e('.pid_tuning input[name="roll_pitch_rate"]').val(t.RC_TUNING.roll_pitch_rate.toFixed(2)),e('.pid_tuning input[name="roll_rate"]').val(t.RC_TUNING.roll_rate.toFixed(2)),e('.pid_tuning input[name="pitch_rate"]').val(t.RC_TUNING.pitch_rate.toFixed(2)),e('.pid_tuning input[name="yaw_rate"]').val(t.RC_TUNING.yaw_rate.toFixed(2)),e('.pid_tuning input[name="rc_expo"]').val(t.RC_TUNING.RC_EXPO.toFixed(2)),e('.pid_tuning input[name="rc_yaw_expo"]').val(t.RC_TUNING.RC_YAW_EXPO.toFixed(2)),e('.throttle input[name="mid"]').val(t.RC_TUNING.throttle_MID.toFixed(2)),e('.throttle input[name="expo"]').val(t.RC_TUNING.throttle_EXPO.toFixed(2)),L.gte(t.CONFIG.apiVersion,Xe)?e('.throttle input[name="hover"]').val(t.RC_TUNING.throttle_HOVER.toFixed(2)):(e('.throttle input[name="hover"]').parent().hide(),e(".throttle thead th:nth-child(2)").hide()),L.gte(t.CONFIG.apiVersion,k)?(e('select[id="tpaMode"]').val(t.ADVANCED_TUNING.tpaMode),e('input[id="tpaRate"]').val(t.ADVANCED_TUNING.tpaRate*100),e('input[id="tpaBreakpoint"]').val(t.ADVANCED_TUNING.tpaBreakpoint)):(e('.tpa-old input[name="tpa"]').val(t.RC_TUNING.dynamic_THR_PID.toFixed(2)),e('.tpa-old input[name="tpa-breakpoint"]').val(t.RC_TUNING.dynamic_THR_breakpoint)),e(".vbatpidcompensation").toggle(g),e('input[id="vbatpidcompensation"]').prop("checked",t.ADVANCED_TUNING.vbatPidCompensation!==0),e("#pid-tuning .delta select").val(t.ADVANCED_TUNING.deltaMethod),e('.pid_tuning input[name="rc_rate_yaw"]').val(t.RC_TUNING.rcYawRate.toFixed(2)),e('.pid_filter input[name="gyroLowpassFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_hz),e('.pid_filter input[name="dtermLowpassFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_hz),e('.pid_filter input[name="yawLowpassFrequency"]').val(t.FILTER_CONFIG.yaw_lowpass_hz),e("#pid-tuning .rate").text(E.getMessage("pidTuningSuperRate")),e('.pid_filter input[name="gyroNotch1Frequency"]').val(t.FILTER_CONFIG.gyro_notch_hz),e('.pid_filter input[name="gyroNotch1Cutoff"]').val(t.FILTER_CONFIG.gyro_notch_cutoff),e('.pid_filter input[name="dTermNotchFrequency"]').val(t.FILTER_CONFIG.dterm_notch_hz),e('.pid_filter input[name="dTermNotchCutoff"]').val(t.FILTER_CONFIG.dterm_notch_cutoff),e('input[name="dtermSetpointTransition-number"]').val(t.ADVANCED_TUNING.dtermSetpointTransition/100),e('input[name="dtermSetpoint-number"]').val(t.ADVANCED_TUNING.dtermSetpointWeight/100),e('.pid_filter input[name="gyroNotch2Frequency"]').val(t.FILTER_CONFIG.gyro_notch2_hz),e('.pid_filter input[name="gyroNotch2Cutoff"]').val(t.FILTER_CONFIG.gyro_notch2_cutoff),e('.pid_tuning input[name="angleLimit"]').val(t.ADVANCED_TUNING.levelAngleLimit),e('.pid_tuning input[name="sensitivity"]').hide(),e(".pid_tuning .levelSensitivityHeader").empty();const m=e("#antiGravitySwitch"),h=e('.antigravity input[name="itermAcceleratorGain"]');e('.pid_filter select[name="dtermLowpassType"]').val(t.FILTER_CONFIG.dterm_lowpass_type);const I=0;L.gte(t.CONFIG.apiVersion,k)?(h.val(t.ADVANCED_TUNING.antiGravityGain/10),m.prop("checked",t.ADVANCED_TUNING.antiGravityGain!==I)):(e('.antigravity input[name="itermThrottleThreshold"]').val(t.ADVANCED_TUNING.itermThrottleThreshold),h.val(t.ADVANCED_TUNING.itermAcceleratorGain/1e3),m.prop("checked",t.ADVANCED_TUNING.itermAcceleratorGain!==I)),L.gte(t.CONFIG.apiVersion,k)&&h.attr({min:"0.1",max:"25.0",step:"0.1"}),m.on("change",function(){if(m.is(":checked")){if(L.gte(t.CONFIG.apiVersion,k))h.val(Number.parseFloat(t.ADVANCED_TUNING.antiGravityGain/10||8).toFixed(1));else if(t.ADVANCED_TUNING.itermAcceleratorGain===I)h.val(3.5);else{const N=t.ADVANCED_TUNING.itermAcceleratorGain/1e3;h.val(N)}e(".antigravity .suboption").show(),e(".antigravity .antiGravityThres").toggle(L.lt(t.CONFIG.apiVersion,k)&&t.ADVANCED_TUNING.itermAcceleratorGain===0),e(".antigravity .antiGravityMode").toggle(L.lt(t.CONFIG.apiVersion,k))}else L.gte(t.CONFIG.apiVersion,k)?h.val(I/1e3):(e('.antigravity select[id="antiGravityMode"]').val(0),h.val(I)),e(".antigravity .suboption").hide()}),m.trigger("change"),e('.pid_tuning input[name="rc_rate_pitch"]').val(t.RC_TUNING.rcPitchRate.toFixed(2)),e('.pid_tuning input[name="rc_pitch_expo"]').val(t.RC_TUNING.RC_PITCH_EXPO.toFixed(2)),e('.pid_filter input[name="gyroLowpass2Frequency"]').val(t.FILTER_CONFIG.gyro_lowpass2_hz),e('.pid_filter select[name="gyroLowpassType"]').val(t.FILTER_CONFIG.gyro_lowpass_type),e('.pid_filter select[name="gyroLowpass2Type"]').val(t.FILTER_CONFIG.gyro_lowpass2_type),e('.pid_filter input[name="dtermLowpass2Frequency"]').val(t.FILTER_CONFIG.dterm_lowpass2_hz),e('.pid_filter select[name="dtermLowpass2Type"]').val(t.FILTER_CONFIG.dterm_lowpass2_type),e('input[id="itermrotation"]').prop("checked",t.ADVANCED_TUNING.itermRotation!==0),e('input[id="smartfeedforward"]').prop("checked",t.ADVANCED_TUNING.smartFeedforward!==0);const C=e('input[id="itermrelax"]');if(C.prop("checked",t.ADVANCED_TUNING.itermRelax!==0),e('select[id="itermrelaxAxes"]').val(t.ADVANCED_TUNING.itermRelax>0?t.ADVANCED_TUNING.itermRelax:1),e('select[id="itermrelaxType"]').val(t.ADVANCED_TUNING.itermRelaxType),e('input[name="itermRelaxCutoff"]').val(t.ADVANCED_TUNING.itermRelaxCutoff),C.change(function(){e(this).is(":checked")?(e(".itermrelax .suboption").show(),e(".itermRelaxCutoff").show()):e(".itermrelax .suboption").hide()}),C.change(),e('input[name="absoluteControlGain-number"]').val(t.ADVANCED_TUNING.absoluteControlGain).trigger("input"),e('input[name="throttleBoost-number"]').val(t.ADVANCED_TUNING.throttleBoost).trigger("input"),e('input[name="acroTrainerAngleLimit-number"]').val(t.ADVANCED_TUNING.acroTrainerAngleLimit).trigger("input"),e('.pid_tuning .YAW input[name="d"]').val(t.PIDS[2][2]),e('.pid_tuning .ROLL input[name="f"]').val(t.ADVANCED_TUNING.feedforwardRoll),e('.pid_tuning .PITCH input[name="f"]').val(t.ADVANCED_TUNING.feedforwardPitch),e('.pid_tuning .YAW input[name="f"]').val(t.ADVANCED_TUNING.feedforwardYaw),e('input[name="feedforwardTransition-number"]').val(Number.parseFloat(t.ADVANCED_TUNING.feedforwardTransition/100).toFixed(2)),L.lt(t.CONFIG.apiVersion,k)){const l=e('.antigravity select[id="antiGravityMode"]');l.on("change",function(){const N=l.val();e(".antiGravityThres").toggle(N!==0)}),l.val(t.ADVANCED_TUNING.antiGravityMode).trigger("change")}e('select[id="throttleLimitType"]').val(t.RC_TUNING.throttleLimitType),e('.throttle_limit input[name="throttleLimitPercent"]').val(t.RC_TUNING.throttleLimitPercent),e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz),e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz),e('.pid_filter select[name="gyroLowpassDynType"]').val(t.FILTER_CONFIG.gyro_lowpass_type),e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz),e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz),e('.pid_filter select[name="dtermLowpassDynType"]').val(t.FILTER_CONFIG.dterm_lowpass_type),e('.pid_tuning input[name="dMaxRoll"]').val(t.ADVANCED_TUNING.dMaxRoll),e('.pid_tuning input[name="dMaxPitch"]').val(t.ADVANCED_TUNING.dMaxPitch),e('.pid_tuning input[name="dMaxYaw"]').val(t.ADVANCED_TUNING.dMaxYaw),e('.dMaxGroup input[name="dMaxGain"]').val(t.ADVANCED_TUNING.dMaxGain),e('.dMaxGroup input[name="dMaxAdvance"]').val(t.ADVANCED_TUNING.dMaxAdvance),e('input[id="useIntegratedYaw"]').prop("checked",t.ADVANCED_TUNING.useIntegratedYaw!==0),e(".smartfeedforward").hide();const z=t.CONFIG.sampleRateHz/t.PID_ADVANCED_CONFIG.pid_process_denom;let S=t.FEATURE_CONFIG.features.isEnabled("DYNAMIC_FILTER");S=S||t.FILTER_CONFIG.dyn_notch_count!==0,S=S&&z>=2e3;const j=e('.pid_filter select[name="dynamicNotchRange"]'),B=e('.pid_filter input[name="dynamicNotchWidthPercent"]'),O=e('.pid_filter input[name="dynamicNotchCount"]'),Q=e('.pid_filter input[name="dynamicNotchQ"]'),se=e('.pid_filter input[name="dynamicNotchMinHz"]'),ee=e('.pid_filter input[name="dynamicNotchMaxHz"]');j.val(t.FILTER_CONFIG.dyn_notch_range),B.val(t.FILTER_CONFIG.dyn_notch_width_percent),O.val(t.FILTER_CONFIG.dyn_notch_count),Q.val(t.FILTER_CONFIG.dyn_notch_q),se.val(t.FILTER_CONFIG.dyn_notch_min_hz),ee.val(t.FILTER_CONFIG.dyn_notch_max_hz),e('.pid_filter input[id="dynamicNotchEnabled"]').on("change",function(){const l=parseInt(O.val()),N=e(this).is(":checked");N&&!l&&O.val(o.dyn_notch_count),e(".dynamicNotch span.suboption").toggle(N),e(".dynamicNotchMaxHz").toggle(N),e(".dynamicNotchCount").toggle(N)}).prop("checked",S).trigger("change"),e(".rpmFilter").toggle(t.MOTOR_CONFIG.use_dshot_telemetry);const J=e('.pid_filter input[name="rpmFilterHarmonics"]'),P=e('.pid_filter input[name="rpmFilterMinHz"]');J.val(t.FILTER_CONFIG.gyro_rpm_notch_harmonics),P.val(t.FILTER_CONFIG.gyro_rpm_notch_min_hz),e(".pid_filter #rpmFilterEnabled").on("change",function(){const l=J.val(),N=e(this).is(":checked")&&l!==0;J.attr("disabled",!N),P.attr("disabled",!N),i.previousFilterDynQ=t.FILTER_CONFIG.dyn_notch_q,i.previousFilterDynCount=t.FILTER_CONFIG.dyn_notch_count,l==0&&J.val(o.gyro_rpm_notch_harmonics);const x={title:E.getMessage("dialogDynFiltersChangeTitle"),text:E.getMessage("dialogDynFiltersChangeNote"),buttonYesText:E.getMessage("presetsWarningDialogYesButton"),buttonNoText:E.getMessage("presetsWarningDialogNoButton"),buttonYesCallback:()=>b(),buttonNoCallback:null},b=function(){N?(O.val(o.dyn_notch_count_rpm),Q.val(o.dyn_notch_q_rpm)):(O.val(o.dyn_notch_count),Q.val(o.dyn_notch_q))};N!==(t.FILTER_CONFIG.gyro_rpm_notch_harmonics!==0)?Re.showYesNoDialog(x):(O.val(i.previousFilterDynCount),Q.val(i.previousFilterDynQ)),e(".rpmFilter span.suboption").toggle(N)}).prop("checked",t.FILTER_CONFIG.gyro_rpm_notch_harmonics!==0).trigger("change"),L.gte(t.CONFIG.apiVersion,k)&&e('input[name="idleMinRpm-number"]').attr("max",200),e('.tab-pid_tuning input[name="motorLimit"]').val(t.ADVANCED_TUNING.motorOutputLimit),e('.tab-pid_tuning select[name="cellCount"]').val(t.ADVANCED_TUNING.autoProfileCellCount),e('input[name="idleMinRpm-number"]').val(t.ADVANCED_TUNING.idleMinRpm).prop("disabled",!t.MOTOR_CONFIG.use_dshot_telemetry),t.MOTOR_CONFIG.use_dshot_telemetry?e("span.pidTuningIdleMinRpmDisabled").text(E.getMessage("pidTuningIdleMinRpm")):e("span.pidTuningIdleMinRpmDisabled").text(E.getMessage("pidTuningIdleMinRpmDisabled"));const X=e('select[id="ratesType"]'),H=[{name:"Ovobot"},{name:"Raceflight"},{name:"KISS"},{name:"Actual"},{name:"QuickRates"}];for(let l=0;l<H.length;l++)X.append(`<option value="${l}">${H[l].name}</option>`);X.sortSelect(),i.currentRatesType=t.RC_TUNING.rates_type,i.previousRatesType=null,X.val(i.currentRatesType),i.changeRatesType(i.currentRatesType),e('.pid_filter input[name="dtermLowpassExpo"]').val(t.FILTER_CONFIG.dyn_lpf_curve_expo),e('select[id="feedforwardAveraging"]').val(t.ADVANCED_TUNING.feedforward_averaging),e('input[name="feedforwardSmoothFactor"]').val(t.ADVANCED_TUNING.feedforward_smooth_factor),e('input[name="feedforwardBoost"]').val(t.ADVANCED_TUNING.feedforward_boost),e('input[name="feedforwardMaxRateLimit"]').val(t.ADVANCED_TUNING.feedforward_max_rate_limit),e('input[name="feedforwardJitterFactor"]').val(t.ADVANCED_TUNING.feedforward_jitter_factor);const oe=t.BATTERY_CONFIG.voltageMeterSource!==1,le=e('input[id="vbatSagCompensation"]').attr("disabled",oe).change();le.prop("checked",t.ADVANCED_TUNING.vbat_sag_compensation!==0),e('input[name="vbatSagValue"]').val(t.ADVANCED_TUNING.vbat_sag_compensation>0?t.ADVANCED_TUNING.vbat_sag_compensation:100),le.change(function(){const l=e(this).is(":checked");e(".vbatSagCompensation .suboption").toggle(l)}).change();const ae=e('input[id="thrustLinearization"]');ae.prop("checked",t.ADVANCED_TUNING.thrustLinearization!==0),e('input[name="thrustLinearValue"]').val(t.ADVANCED_TUNING.thrustLinearization>0?t.ADVANCED_TUNING.thrustLinearization:20),ae.change(function(){const l=e(this).is(":checked");e(".thrustLinearization .suboption").toggle(l)}).change(),e('input[id="useIntegratedYaw"]').change(function(){const l=e(this).is(":checked");e("#pidTuningIntegratedYawCaution").toggle(l)}).change();function ce(l,N){const x=parseInt(l.val()),b=parseInt(N.val()),D=Math.min(Math.max(x,0),250),xe=Math.min(Math.max(b,0),250);b>D&&N.val(D),x<xe&&l.val(xe)}function Ee(l){const N=e(`.pid_tuning input[name="dMax${l}"]`),x=e(`.pid_tuning .${l} input[name="d"]`);N.change(function(){ce(x,N)}).change(),x.change(function(){ce(x,N)}).change()}["Roll","Pitch","Yaw"].forEach(l=>Ee(l)),e('input[id="gyroNotch1Enabled"]').change(function(){const l=e(this).is(":checked"),N=t.FILTER_CONFIG.gyro_notch_hz>0?t.FILTER_CONFIG.gyro_notch_hz:o.gyro_notch_hz;e('.pid_filter input[name="gyroNotch1Frequency"]').val(l?N:0).attr("disabled",!l).attr("min",l?1:0).change(),e('.pid_filter input[name="gyroNotch1Cutoff"]').attr("disabled",!l).change(),e(".gyroNotch1 span.suboption").toggle(l)}),e('input[id="gyroNotch2Enabled"]').change(function(){const l=e(this).is(":checked"),N=t.FILTER_CONFIG.gyro_notch2_hz>0?t.FILTER_CONFIG.gyro_notch2_hz:o.gyro_notch2_hz;e('.pid_filter input[name="gyroNotch2Frequency"]').val(l?N:0).attr("disabled",!l).attr("min",l?1:0).change(),e('.pid_filter input[name="gyroNotch2Cutoff"]').attr("disabled",!l).change(),e(".gyroNotch2 span.suboption").toggle(l)}),e('input[id="dtermNotchEnabled"]').change(function(){const l=e(this).is(":checked"),N=t.FILTER_CONFIG.dterm_notch_hz>0?t.FILTER_CONFIG.dterm_notch_hz:o.dterm_notch_hz;e('.pid_filter input[name="dTermNotchFrequency"]').val(l?N:0).attr("disabled",!l).attr("min",l?1:0).change(),e('.pid_filter input[name="dTermNotchCutoff"]').attr("disabled",!l).change(),e(".dtermNotch span.suboption").toggle(l)});const Ne=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),Ie=e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]'),me=e('.pid_filter input[name="gyroLowpassFrequency"]'),Fe=e('.pid_filter input[name="gyroLowpass2Frequency"]'),Ge=e('.pid_filter input[id="gyroLowpassEnabled"]'),De=e('.pid_filter input[id="gyroLowpass2Enabled"]'),be=e(".gyroLowpass span.suboption"),Le=e(".gyroLowpass span.suboption.static"),Z=e(".gyroLowpass span.suboption.dynamic"),ue=e(".gyroLowpass2 span.suboption"),ye=e('.pid_filter select[name="gyroLowpassFilterMode"]'),a=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),d=e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]'),f=e('.pid_filter input[name="dtermLowpassFrequency"]'),U=e('.pid_filter input[name="dtermLowpass2Frequency"]'),ge=e('input[id="dtermLowpassEnabled"]'),Ce=e('input[id="dtermLowpass2Enabled"]'),Oe=e(".dtermLowpass span.suboption"),Ae=e(".dtermLowpass span.suboption.static"),ke=e(".dtermLowpass span.suboption.dynamic"),We=e(".dtermLowpass2 span.suboption"),te=e('.pid_filter select[name="dtermLowpassFilterMode"]');Ge.change(function(){const l=e(this).is(":checked");l?t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0||t.FILTER_CONFIG.gyro_lowpass_hz>0?ye.val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0?1:0).change():ye.val(1).change():(Ne.val(0),Ie.val(0),me.val(0),i.calculateNewGyroFilters()),be.toggle(l),Le.toggle(l&&t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz===0),Z.toggle(l&&t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz!==0)}),ye.change(function(){const l=parseInt(e(this).val()),N=t.FILTER_CONFIG.gyro_lowpass_hz>0?t.FILTER_CONFIG.gyro_lowpass_hz:o.gyro_lowpass_hz,x=t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0?t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz:o.gyro_lowpass_dyn_min_hz,b=t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz>0?t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz:o.gyro_lowpass_dyn_max_hz;me.val(l?0:N),Ne.val(l?x:0),Ie.val(l?b:0),i.calculateNewGyroFilters(),Le.toggle(!l),Z.toggle(!!l)}),De.change(function(){const l=e(this).is(":checked"),N=t.FILTER_CONFIG.gyro_lowpass2_hz>0?t.FILTER_CONFIG.gyro_lowpass2_hz:o.gyro_lowpass2_hz;Fe.val(l?N:0).attr("disabled",!l),i.calculateNewGyroFilters(),ue.toggle(l),i.updateFilterWarning()}),ge.change(function(){const l=e(this).is(":checked");l?t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0||t.FILTER_CONFIG.dterm_lowpass_hz>0?te.val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0?1:0).change():te.val(1).change():(a.val(0),d.val(0),f.val(0),i.calculateNewDTermFilters()),Oe.toggle(l),Ae.toggle(l&&t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz===0),ke.toggle(l&&t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz!==0)}),te.change(function(){const l=parseInt(e(this).val()),N=t.FILTER_CONFIG.dterm_lowpass_hz>0?t.FILTER_CONFIG.dterm_lowpass_hz:o.dterm_lowpass_hz,x=t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0?t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz:o.dterm_lowpass_dyn_min_hz,b=t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz>0?t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz:o.dterm_lowpass_dyn_max_hz;f.val(l?0:N),a.val(l?x:0),d.val(l?b:0),i.calculateNewDTermFilters(),Ae.toggle(!l),ke.toggle(!!l)}),Ce.change(function(){const l=e(this).is(":checked"),N=t.FILTER_CONFIG.dterm_lowpass2_hz>0?t.FILTER_CONFIG.dterm_lowpass2_hz:o.dterm_lowpass2_hz;U.val(l?N:0).attr("disabled",!l),i.calculateNewDTermFilters(),We.toggle(l),i.updateFilterWarning()}),e('input[id="yawLowpassEnabled"]').change(function(){const l=e(this).is(":checked"),N=t.FILTER_CONFIG.yaw_lowpass_hz>0?t.FILTER_CONFIG.yaw_lowpass_hz:o.yaw_lowpass_hz;e('.pid_filter input[name="yawLowpassFrequency"]').val(l?N:0).attr("disabled",!l),e(".yawLowpass span.suboption").toggle(l)});function fe(l,N){const x=parseInt(e(`.pid_filter input[name='${l}']`).val()),b=parseInt(e(`.pid_filter input[name='${N}']`).val()),D=x==0?0:x-1;e(`.pid_filter input[name='${N}']`).attr("max",D),b>=x&&e(`.pid_filter input[name='${N}']`).val(D)}e('input[name="gyroNotch1Frequency"]').change(function(){fe("gyroNotch1Frequency","gyroNotch1Cutoff")}).change(),e('input[name="gyroNotch2Frequency"]').change(function(){fe("gyroNotch2Frequency","gyroNotch2Cutoff")}).change(),e('input[name="dTermNotchFrequency"]').change(function(){fe("dTermNotchFrequency","dTermNotchCutoff")}).change(),e('input[id="gyroNotch1Enabled"]').prop("checked",t.FILTER_CONFIG.gyro_notch_hz!==0).change(),e('input[id="gyroNotch2Enabled"]').prop("checked",t.FILTER_CONFIG.gyro_notch2_hz!==0).change(),e('input[id="dtermNotchEnabled"]').prop("checked",t.FILTER_CONFIG.dterm_notch_hz!==0).change(),Ge.prop("checked",t.FILTER_CONFIG.gyro_lowpass_hz!==0||t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz!==0).change(),ge.prop("checked",t.FILTER_CONFIG.dterm_lowpass_hz!==0||t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz!==0).change(),De.prop("checked",t.FILTER_CONFIG.gyro_lowpass2_hz!==0).change(),Ce.prop("checked",t.FILTER_CONFIG.dterm_lowpass2_hz!==0).change(),e('input[id="yawLowpassEnabled"]').prop("checked",t.FILTER_CONFIG.yaw_lowpass_hz!==0).change(),i.updatePIDColors()}function T(){L.gte(t.CONFIG.apiVersion,"1.45.0")&&(t.CONFIG.pidProfileNames[t.CONFIG.profile]=e('input[name="pidProfileName"]').val().trim(),t.CONFIG.rateProfileNames[t.CONFIG.rateProfile]=e('input[name="rateProfileName"]').val().trim()),t.PID_NAMES.forEach(function(se,ee){e(`.pid_tuning .${se} input`).each(function(P){e(this).val()&&(t.PIDS[ee][P]=parseInt(e(this).val()))})});const m=e('.pid_tuning input[name="pitch_rate"]'),h=e('.pid_tuning input[name="roll_rate"]'),I=e('.pid_tuning input[name="yaw_rate"]'),C=e('.pid_tuning input[name="rc_rate_pitch"]'),w=e('.pid_tuning input[name="rc_rate"]'),G=e('.pid_tuning input[name="rc_rate_yaw"]'),V=e('.pid_tuning input[name="rc_pitch_expo"]'),v=e('.pid_tuning input[name="rc_expo"]'),z=e('.pid_tuning input[name="rc_yaw_expo"]');switch(t.RC_TUNING.roll_pitch_rate=parseFloat(e('.pid_tuning input[name="roll_pitch_rate"]').val()),t.RC_TUNING.RC_RATE=parseFloat(w.val()),t.RC_TUNING.roll_rate=parseFloat(h.val()),t.RC_TUNING.pitch_rate=parseFloat(m.val()),t.RC_TUNING.yaw_rate=parseFloat(I.val()),t.RC_TUNING.RC_EXPO=parseFloat(v.val()),t.RC_TUNING.RC_YAW_EXPO=parseFloat(z.val()),t.RC_TUNING.rcYawRate=parseFloat(G.val()),t.RC_TUNING.rcPitchRate=parseFloat(C.val()),t.RC_TUNING.RC_PITCH_EXPO=parseFloat(V.val()),i.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:t.RC_TUNING.pitch_rate=parseFloat(m.val())/100,t.RC_TUNING.roll_rate=parseFloat(h.val())/100,t.RC_TUNING.yaw_rate=parseFloat(I.val())/100,t.RC_TUNING.rcPitchRate=parseFloat(C.val())/1e3,t.RC_TUNING.RC_RATE=parseFloat(w.val())/1e3,t.RC_TUNING.rcYawRate=parseFloat(G.val())/1e3,t.RC_TUNING.RC_PITCH_EXPO=parseFloat(V.val())/100,t.RC_TUNING.RC_EXPO=parseFloat(v.val())/100,t.RC_TUNING.RC_YAW_EXPO=parseFloat(z.val())/100;break;case t.RATES_TYPE.ACTUAL:t.RC_TUNING.pitch_rate=parseFloat(m.val())/1e3,t.RC_TUNING.roll_rate=parseFloat(h.val())/1e3,t.RC_TUNING.yaw_rate=parseFloat(I.val())/1e3,t.RC_TUNING.rcPitchRate=parseFloat(C.val())/1e3,t.RC_TUNING.RC_RATE=parseFloat(w.val())/1e3,t.RC_TUNING.rcYawRate=parseFloat(G.val())/1e3;break;case t.RATES_TYPE.QUICKRATES:t.RC_TUNING.pitch_rate=parseFloat(m.val())/1e3,t.RC_TUNING.roll_rate=parseFloat(h.val())/1e3,t.RC_TUNING.yaw_rate=parseFloat(I.val())/1e3;break}t.RC_TUNING.throttle_MID=parseFloat(e('.throttle input[name="mid"]').val()),t.RC_TUNING.throttle_EXPO=parseFloat(e('.throttle input[name="expo"]').val()),t.RC_TUNING.throttle_HOVER=parseFloat(e('.throttle input[name="hover"]').val()),L.gte(t.CONFIG.apiVersion,k)?(t.ADVANCED_TUNING.tpaMode=e('select[id="tpaMode"]').val(),t.ADVANCED_TUNING.tpaRate=parseInt(e('input[id="tpaRate"]').val())/100,t.ADVANCED_TUNING.tpaBreakpoint=parseInt(e('input[id="tpaBreakpoint"]').val())):(t.RC_TUNING.dynamic_THR_PID=parseFloat(e('.tpa-old input[name="tpa"]').val()),t.RC_TUNING.dynamic_THR_breakpoint=parseInt(e('.tpa-old input[name="tpa-breakpoint"]').val())),t.FILTER_CONFIG.gyro_lowpass_hz=parseInt(e('.pid_filter input[name="gyroLowpassFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_hz=parseInt(e('.pid_filter input[name="dtermLowpassFrequency"]').val()),t.FILTER_CONFIG.yaw_lowpass_hz=parseInt(e('.pid_filter input[name="yawLowpassFrequency"]').val()),t.ADVANCED_TUNING.deltaMethod=e("#pid-tuning .delta select").val(),t.ADVANCED_TUNING.dtermSetpointTransition=parseInt(e('input[name="dtermSetpointTransition-number"]').val()*100),t.ADVANCED_TUNING.dtermSetpointWeight=parseInt(e('input[name="dtermSetpoint-number"]').val()*100),t.FILTER_CONFIG.gyro_notch_hz=parseInt(e('.pid_filter input[name="gyroNotch1Frequency"]').val()),t.FILTER_CONFIG.gyro_notch_cutoff=parseInt(e('.pid_filter input[name="gyroNotch1Cutoff"]').val()),t.FILTER_CONFIG.dterm_notch_hz=parseInt(e('.pid_filter input[name="dTermNotchFrequency"]').val()),t.FILTER_CONFIG.dterm_notch_cutoff=parseInt(e('.pid_filter input[name="dTermNotchCutoff"]').val()),t.FILTER_CONFIG.gyro_notch2_hz=parseInt(e('.pid_filter input[name="gyroNotch2Frequency"]').val()),t.FILTER_CONFIG.gyro_notch2_cutoff=parseInt(e('.pid_filter input[name="gyroNotch2Cutoff"]').val()),t.ADVANCED_TUNING.levelAngleLimit=parseInt(e('.pid_tuning input[name="angleLimit"]').val());const S=e('.antigravity input[name="itermAcceleratorGain"]');t.FILTER_CONFIG.dterm_lowpass_type=parseInt(e('.pid_filter select[name="dtermLowpassType"]').val()),L.gte(t.CONFIG.apiVersion,k)?t.ADVANCED_TUNING.antiGravityGain=parseInt(S.val()*10):(t.ADVANCED_TUNING.itermThrottleThreshold=parseInt(e('.antigravity input[name="itermThrottleThreshold"]').val()),t.ADVANCED_TUNING.itermAcceleratorGain=parseInt(S.val()*1e3)),t.FILTER_CONFIG.gyro_lowpass2_hz=parseInt(e('.pid_filter input[name="gyroLowpass2Frequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_type=parseInt(e('.pid_filter select[name="gyroLowpassType"]').val()),t.FILTER_CONFIG.gyro_lowpass2_type=parseInt(e('.pid_filter select[name="gyroLowpass2Type"]').val()),t.FILTER_CONFIG.dterm_lowpass2_hz=parseInt(e('.pid_filter input[name="dtermLowpass2Frequency"]').val()),t.FILTER_CONFIG.dterm_lowpass2_type=parseInt(e('.pid_filter select[name="dtermLowpass2Type"]').val()),t.ADVANCED_TUNING.itermRotation=e('input[id="itermrotation"]').is(":checked")?1:0,t.ADVANCED_TUNING.smartFeedforward=e('input[id="smartfeedforward"]').is(":checked")?1:0,t.ADVANCED_TUNING.itermRelax=e('input[id="itermrelax"]').is(":checked")?e('select[id="itermrelaxAxes"]').val():0,t.ADVANCED_TUNING.itermRelaxType=e('select[id="itermrelaxType"]').val(),t.ADVANCED_TUNING.itermRelaxCutoff=parseInt(e('input[name="itermRelaxCutoff"]').val()),t.ADVANCED_TUNING.absoluteControlGain=e('input[name="absoluteControlGain-number"]').val(),t.ADVANCED_TUNING.throttleBoost=e('input[name="throttleBoost-number"]').val(),t.ADVANCED_TUNING.acroTrainerAngleLimit=e('input[name="acroTrainerAngleLimit-number"]').val(),t.ADVANCED_TUNING.feedforwardRoll=parseInt(e('.pid_tuning .ROLL input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardPitch=parseInt(e('.pid_tuning .PITCH input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardYaw=parseInt(e('.pid_tuning .YAW input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardTransition=parseInt(e('input[name="feedforwardTransition-number"]').val()*100),t.ADVANCED_TUNING.antiGravityMode=L.lt(t.CONFIG.apiVersion,k)?e('select[id="antiGravityMode"]').val():0,t.RC_TUNING.throttleLimitType=e('select[id="throttleLimitType"]').val(),t.RC_TUNING.throttleLimitPercent=parseInt(e('.throttle_limit input[name="throttleLimitPercent"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]').val()),t.ADVANCED_TUNING.dMaxRoll=parseInt(e('.pid_tuning input[name="dMaxRoll"]').val()),t.ADVANCED_TUNING.dMaxPitch=parseInt(e('.pid_tuning input[name="dMaxPitch"]').val()),t.ADVANCED_TUNING.dMaxYaw=parseInt(e('.pid_tuning input[name="dMaxYaw"]').val()),t.ADVANCED_TUNING.dMaxGain=parseInt(e('.dMaxGroup input[name="dMaxGain"]').val()),t.ADVANCED_TUNING.dMaxAdvance=parseInt(e('.dMaxGroup input[name="dMaxAdvance"]').val()),t.ADVANCED_TUNING.useIntegratedYaw=e('input[id="useIntegratedYaw"]').is(":checked")?1:0,t.FILTER_CONFIG.dyn_notch_range=parseInt(e('.pid_filter select[name="dynamicNotchRange"]').val()),t.FILTER_CONFIG.dyn_notch_width_percent=parseInt(e('.pid_filter input[name="dynamicNotchWidthPercent"]').val()),t.FILTER_CONFIG.dyn_notch_q=parseInt(e('.pid_filter input[name="dynamicNotchQ"]').val()),t.FILTER_CONFIG.dyn_notch_min_hz=parseInt(e('.pid_filter input[name="dynamicNotchMinHz"]').val());const j=e(".pid_filter #rpmFilterEnabled").is(":checked");t.FILTER_CONFIG.gyro_rpm_notch_harmonics=j?parseInt(e('.pid_filter input[name="rpmFilterHarmonics"]').val()):0,t.FILTER_CONFIG.gyro_rpm_notch_min_hz=parseInt(e('.pid_filter input[name="rpmFilterMinHz"]').val()),t.FILTER_CONFIG.dyn_notch_max_hz=parseInt(e('.pid_filter input[name="dynamicNotchMaxHz"]').val()),t.ADVANCED_TUNING.motorOutputLimit=parseInt(e('.tab-pid_tuning input[name="motorLimit"]').val()),t.ADVANCED_TUNING.autoProfileCellCount=parseInt(e('.tab-pid_tuning select[name="cellCount"]').val()),t.ADVANCED_TUNING.idleMinRpm=parseInt(e('input[name="idleMinRpm-number"]').val());const B=e('select[id="ratesType"]').val();let O;B!==t.RC_TUNING.rates_type&&(O=e('select[id="ratesType"]').find("option:selected").text()),i.analyticsChanges.RatesType=O,t.RC_TUNING.rates_type=B,t.ADVANCED_TUNING.feedforward_averaging=e('select[id="feedforwardAveraging"]').val(),t.ADVANCED_TUNING.feedforward_smooth_factor=parseInt(e('input[name="feedforwardSmoothFactor"]').val()),t.ADVANCED_TUNING.feedforward_boost=parseInt(e('input[name="feedforwardBoost"]').val()),t.ADVANCED_TUNING.feedforward_max_rate_limit=parseInt(e('input[name="feedforwardMaxRateLimit"]').val()),t.ADVANCED_TUNING.feedforward_jitter_factor=parseInt(e('input[name="feedforwardJitterFactor"]').val()),t.FILTER_CONFIG.dyn_lpf_curve_expo=parseInt(e('.pid_filter input[name="dtermLowpassDynExpo"]').val()),t.ADVANCED_TUNING.vbat_sag_compensation=e('input[id="vbatSagCompensation"]').is(":checked")?parseInt(e('input[name="vbatSagValue"]').val()):0,t.ADVANCED_TUNING.thrustLinearization=e('input[id="thrustLinearization"]').is(":checked")?parseInt(e('input[name="thrustLinearValue"]').val()):0,t.FILTER_CONFIG.dyn_lpf_curve_expo=parseInt(e('.pid_filter input[name="dtermLowpassExpo"]').val());const Q=e('.pid_filter input[id="dynamicNotchEnabled"]').is(":checked");t.FILTER_CONFIG.dyn_notch_count=Q?parseInt(e('.pid_filter input[name="dynamicNotchCount"]').val()):0,t.TUNING_SLIDERS.slider_pids_mode=s.sliderPidsMode,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(s.sliderMasterMultiplier*20)*5,t.TUNING_SLIDERS.slider_d_gain=Math.round(s.sliderDGain*20)*5,t.TUNING_SLIDERS.slider_pi_gain=Math.round(s.sliderPIGain*20)*5,t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(s.sliderFeedforwardGain*20)*5,t.TUNING_SLIDERS.slider_i_gain=Math.round(s.sliderIGain*20)*5,t.TUNING_SLIDERS.slider_dmax_gain=Math.round(s.sliderDMaxGain*20)*5,t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(s.sliderRollPitchRatio*20)*5,t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(s.sliderPitchPIGain*20)*5,t.TUNING_SLIDERS.slider_dterm_filter=s.sliderDTermFilter,t.TUNING_SLIDERS.slider_dterm_filter_multiplier=Math.round(s.sliderDTermFilterMultiplier*20)*5,t.TUNING_SLIDERS.slider_gyro_filter=s.sliderGyroFilter,t.TUNING_SLIDERS.slider_gyro_filter_multiplier=Math.round(s.sliderGyroFilterMultiplier*20)*5}function _(){e(".pid_optional tr").hide(),e(".pid_optional table").hide(),e(".pid_optional").hide(),t.PID_NAMES.forEach(function(m){e(`.pid_tuning .${m}`).show(),e(`.needed_by_${m}`).show()})}function p(){it(t.CONFIG.activeSensors,"acc")||(e("#pid_accel").hide(),e(".acroTrainerAngleLimit").hide()),e("#pid_baro_mag_gps").hide()}function R(m,h,I){m.strokeStyle="#888888",m.lineWidth=4,m.beginPath(),m.moveTo(0,I/2),m.lineTo(h,I/2),m.stroke(),m.beginPath(),m.moveTo(h/2,0),m.lineTo(h/2,I),m.stroke()}function M(m){let h=parseFloat(m.val());return(h<parseFloat(m.prop("min"))||h>parseFloat(m.prop("max")))&&(h=void 0),h}const F=!1;i.rateCurve=new lt(F),e('.pid_tuning input[name="sensitivity"]').hide(),e(".pid_tuning .levelSensitivityHeader").empty();function Y(m,h,I,C,w,G,V){const v=i.rateCurve.getMaxAngularVel(m,h,I,C,w,G).toFixed(0);return V.text(v),v}function q(m,h,I,C,w,G,V,v,z,S){S.save(),S.strokeStyle=v,S.translate(0,z),i.rateCurve.draw(m,h,I,C,w,G,V,S),S.restore()}function pe(){if(Ue.pid_tuning.isHtmlProcessing=!0,t.FEATURE_CONFIG.features.generateElements(e(".tab-pid_tuning .features")),e(".tab-pid_tuning .pidTuningSuperexpoRates").hide(),L.lt(t.CONFIG.apiVersion,Xe)){const a=document.querySelector(".derivative .cf_tip"),d=document.querySelector(".dmax .cf_tip");["i18n","i18n_title"].forEach(f=>{const U=a.getAttribute(f);a.setAttribute(f,d.getAttribute(f)),d.setAttribute(f,U)})}E.localizePage(),i.currentRates=i.rateCurve.getCurrentRates(),e(".tab-pid_tuning .tab-container .pid").on("click",()=>ee("pid")),e(".tab-pid_tuning .tab-container .rates").on("click",()=>ee("rates")),e(".tab-pid_tuning .tab-container .filter").on("click",()=>ee("filter"));function m(){const a=t.CONFIG.numProfiles,d=[];for(let f=0;f<a;f++)d.push(E.getMessage("pidTuningProfileOption",[f+1]));return d}function h(){let a=6;L.gte(t.CONFIG.apiVersion,k)&&(a=4),L.gte(t.CONFIG.apiVersion,Xe)&&(a=t.CONFIG.numberOfRateProfiles);const d=[];for(let f=0;f<a;f++)d.push(E.getMessage("pidTuningRateProfileOption",[f+1]));return d}const I=h(),C=m();function w(a){const d=e('select[name="profile"]');a.forEach(function(f,U){d.append(`<option value="${U}">${f}</option>`)})}w(C);function G(a){const d=e('select[name="rate_profile"]');a.forEach(function(f,U){d.append(`<option value="${U}">${f}</option>`)})}G(I);const V=e("#showAllPids");function v(){i.showAllPids?(_(),V.text(E.getMessage("pidTuningHideUnusedPids"))):(p(),V.text(E.getMessage("pidTuningShowAllPids")))}_(),v(),V.on("click",function(){i.showAllPids=!i.showAllPids,v()}),e("#resetPidProfile").on("click",function(){i.updating=!0,y.promise(u.MSP_SET_RESET_CURR_PID).then(function(){i.refresh(function(){i.updating=!1,Se(E.getMessage("pidTuningPidProfileReset"))})})}),e('.tab-pid_tuning select[name="profile"]').change(function(){i.currentProfile=parseInt(e(this).val()),i.updating=!0,e(this).prop("disabled","true"),y.promise(u.MSP_SELECT_SETTING,[i.currentProfile]).then(function(){i.refresh(function(){i.updating=!1,e('.tab-pid_tuning select[name="profile"]').prop("disabled","false"),t.CONFIG.profile=i.currentProfile,Se(E.getMessage("pidTuningLoadedProfile",[i.currentProfile+1]))})})}),e('.tab-pid_tuning select[name="rate_profile"]').change(function(){i.currentRateProfile=parseInt(e(this).val()),i.updating=!0,e(this).prop("disabled","true"),y.promise(u.MSP_SELECT_SETTING,[i.currentRateProfile+i.RATE_PROFILE_MASK]).then(function(){i.refresh(function(){i.updating=!1,e('.tab-pid_tuning select[name="rate_profile"]').prop("disabled","false"),t.CONFIG.rateProfile=i.currentRateProfile,i.currentRates=i.rateCurve.getCurrentRates(),Se(E.getMessage("pidTuningLoadedRateProfile",[i.currentRateProfile+1]))})})});const z=e('input[name="dtermSetpointTransition-number"]'),S=e("#pid-tuning .dtermSetpointTransitionWarning");function j(a){a>0&&a<.1?S.show():S.hide()}j(z.val()),z.on("input",function(){j(e(this).val())}),e("#pid-tuning .delta").hide(),e(".tab-pid_tuning .note").hide(),e(".pid_tuning tr").each(function(){for(const a of t.PID_NAMES)if(e(this).hasClass(a)){const d=e(this).find("td:first");d.text()||d.text(a)}});function B(){const a=[];return a.push("PT1"),a.push("BIQUAD"),a.push("PT2"),a.push("PT3"),a}function O(a,d){const f=e(`select[name="${a}"]`);d.forEach(function(U,ge){f.append(`<option value="${ge}">${U}</option>`)})}function Q(){return["HIGH","MEDIUM","LOW","AUTO"]}function se(a){const d=e('select[name="dynamicNotchRange"]');a.forEach(function(f,U){d.append(`<option value="${U}">${f}</option>`)})}se(Q()),O("gyroLowpassType",B()),O("gyroLowpass2Type",B()),O("dtermLowpassType",B()),O("dtermLowpass2Type",B()),n();function ee(a){const d=["pid","rates","filter"];if(!d.includes(a)){console.debug(`Invalid subtab name: "${a}"`);return}for(const f of d)e(`.tab-pid_tuning .subtab-${f}`)[f===a?"show":"hide"]();e(".tab-pid_tuning .tab-container .tab").removeClass("active"),e(`.tab-pid_tuning .tab-container .${a}`).addClass("active"),i.activeSubtab=a,a==="rates"?(le(!0),i.throttleDrawInterval=setInterval(le,100)):i.throttleDrawInterval&&(clearInterval(i.throttleDrawInterval),i.throttleDrawInterval=null)}ee(i.activeSubtab),e(".tab-pid_tuning div.controller").hide(),i.updatePidControllerParameters(),e(".pid_tuning .roll_pitch_rate").hide(),L.gte(t.CONFIG.apiVersion,k)?e(".tpa-old").hide():e(".tpa").hide(),e(".pid_tuning .bracket").hide(),e(".pid_tuning input[name=rc_rate]").parent().attr("class","pid_data"),e(".pid_tuning input[name=rc_rate]").parent().attr("rowspan",1),e(".pid_tuning input[name=rc_expo]").parent().attr("class","pid_data"),e(".pid_tuning input[name=rc_expo]").parent().attr("rowspan",1);const J=e(".rate_curve canvas#rate_curve_layer0").get(0),P=J.getContext("2d");let X=!0,H;i.maxAngularVelRollElement=e(".pid_tuning .maxAngularVelRoll"),i.maxAngularVelPitchElement=e(".pid_tuning .maxAngularVelPitch"),i.maxAngularVelYawElement=e(".pid_tuning .maxAngularVelYaw"),i.acroCenterSensitivityRollElement=e(".pid_tuning .acroCenterSensitivityRoll"),i.acroCenterSensitivityPitchElement=e(".pid_tuning .acroCenterSensitivityPitch"),i.acroCenterSensitivityYawElement=e(".pid_tuning .acroCenterSensitivityYaw"),J.width=1e3,J.height=1e3;function oe(a){setTimeout(function(){if(a){const d=e(a.target);let f=M(d);if(i.currentRates.hasOwnProperty(d.attr("name"))&&f!==void 0){const U=parseFloat(d.prop("step"));U!=null&&(f=Math.round(f/U)*U),i.currentRates[d.attr("name")]=f,X=!0}d.attr("name")==="SUPEREXPO_RATES"&&(i.currentRates.superexpo=d.is(":checked"),X=!0),d.attr("id")==="ratesType"&&(i.changeRatesType(f),X=!0)}else X=!0;if(X){const d=J.height,f=J.width,U=P.canvas.width/P.canvas.clientWidth;P.clearRect(0,0,f,d),H=Math.max(Y(i.currentRates.roll_rate,i.currentRates.rc_rate,i.currentRates.rc_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.roll_rate_limit,i.maxAngularVelRollElement),Y(i.currentRates.pitch_rate,i.currentRates.rc_rate_pitch,i.currentRates.rc_pitch_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.pitch_rate_limit,i.maxAngularVelPitchElement),Y(i.currentRates.yaw_rate,i.currentRates.rc_rate_yaw,i.currentRates.rc_yaw_expo,i.currentRates.superexpo,i.currentRates.yawDeadband,i.currentRates.yaw_rate_limit,i.maxAngularVelYawElement)),H=i.rateCurve.setMaxAngularVel(H),R(P,f,d),P.lineWidth=2*U,q(i.currentRates.roll_rate,i.currentRates.rc_rate,i.currentRates.rc_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.roll_rate_limit,H,"#ff0000",0,P),q(i.currentRates.pitch_rate,i.currentRates.rc_rate_pitch,i.currentRates.rc_pitch_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.pitch_rate_limit,H,"#00ff00",-4,P),q(i.currentRates.yaw_rate,i.currentRates.rc_rate_yaw,i.currentRates.rc_yaw_expo,i.currentRates.superexpo,i.currentRates.yawDeadband,i.currentRates.yaw_rate_limit,H,"#0000ff",4,P),i.updateRatesLabels(),X=!1}},0)}e("input.feature").on("input change",function(){const a=e(this);t.FEATURE_CONFIG.features.updateData(a),oe()}),e(".pid_tuning").on("input change",oe).trigger("input");function le(a=!1){if(!a&&!i.checkThrottle())return;function d(re,_e,W,Te){const ne=1-re;return ne*ne*_e+2*ne*re*W+re*re*Te}function f(re,_e,W,Te,ne,Ve,ze){return{x:d(ze,re,W,ne),y:d(ze,_e,Te,Ve)}}function U(re,_e,W,Te){const ne=_e+Te-2*W,Ve=2*(W-_e),ze=_e-re;return ne==0?-ze/Ve:(-Ve-Math.sqrt(Math.pow(Ve,2)-4*ne*ze))/(2*ne)}const ge={SCALE:1,CLIP:2},Ce=e('.throttle input[name="mid"]'),Oe=e('.throttle input[name="expo"]'),Ae=e('.throttle input[name="hover"]'),ke=e('.throttle_limit input[name="throttleLimitPercent"]'),We=e('.throttle_limit select[id="throttleLimitType"]'),te=parseFloat(Ce.val()),fe=parseFloat(Oe.val()),l=parseFloat(Ae.val()),N=parseInt(ke.val())/100,x=parseInt(We.val()),b=e(".throttle .throttle_curve canvas").get(0),D=b.getContext("2d");if(!(te>=parseFloat(Ce.prop("min"))&&te<=parseFloat(Ce.prop("max"))&&fe>=parseFloat(Oe.prop("min"))&&fe<=parseFloat(Oe.prop("max"))&&l>=parseFloat(Ae.prop("min"))&&l<=parseFloat(Ae.prop("max"))))return;b.width=b.height*(b.clientWidth/b.clientHeight);const xe=x===ge.SCALE?N:1,de=b.height,he=b.width,Ye=de*(1-xe),$=he*te,qe=$*(1-fe),He=(he-$)*fe+$,ie=(de-xe)*(1-l),ve=ie,Me=ie;let Pe=(t.RC.channels[3]-1e3)/1e3,we=Pe<=te?f(0,de,qe,ve,$,ie,Pe*(1/te)):f($,ie,He,Me,he,Ye,(Pe-te)*(1/(1-te)));if(D.clearRect(0,0,he,de),D.beginPath(),D.moveTo(0,de),x===ge.CLIP){const re=de*(1-N);we.y=we.y<re?re:we.y;const _e=N<=te?U(re,de,ve,ie):U(re,ie,Me,Ye);let W=f(0,de,qe,ve,$,ie,_e),Te=W.x/2,ne=ve+(de-ve)*($-W.x)/$;N>te&&(D.quadraticCurveTo(qe,ve,$,ie),D.moveTo($,ie),W=f($,ie,He,Me,he,Ye,_e),Te=$+(W.x-$)/2,ne=Me+(ie-Me)*(he-W.x)/(he-$)),D.quadraticCurveTo(Te,ne,W.x,W.y),D.moveTo(W.x,W.y),D.lineTo(he,W.y)}else D.quadraticCurveTo(qe,ve,$,ie),D.moveTo($,ie),D.quadraticCurveTo(He,Me,he,Ye);D.lineWidth=2,D.strokeStyle="#ffbb00",D.stroke(),D.beginPath(),D.arc(we.x,we.y,4,0,2*Math.PI),D.fillStyle=D.strokeStyle,D.fill(),D.save();let Qe=10;D.font=`${Qe}pt Verdana, Arial, sans-serif`;let Ze=Pe*100,et=100-we.y/de*100,Ke=`${Math.round(Pe<=0?0:Ze)}% = ${Math.round(Pe<=0?0:et)}%`,tt=D.measureText(Ke);D.fillStyle="#888888",D.scale(tt/b.clientWidth,1),D.fillText(Ke,5,5+Qe),D.restore()}e(".throttle input, .throttle_limit input, .throttle_limit select").on("change",()=>setTimeout(()=>le(!0),0)),e("a.refresh").click(function(){i.refresh(function(){Se(E.getMessage("pidTuningDataRefreshed"))})}),e("#pid-tuning").find("input").each(function(a,d){e(d).attr("class")!=="feature toggle"&&e(d).attr("class")!=="nonProfile"&&e(d).change(function(){i.setDirty(!0)})});const ae=e(".dialogCopyProfile")[0],ce=0,Ee=1;let Ne;const Ie=e(".selectProfile"),me=e(".selectRateProfile");e.each(C,function(a,d){a!==t.CONFIG.profile&&Ie.append(new Option(d,a))}),e.each(I,function(a,d){a!==t.CONFIG.rateProfile&&me.append(new Option(d,a))}),e(".copyprofilebtn").click(function(){e(".dialogCopyProfile").find(".contentProfile").show(),e(".dialogCopyProfile").find(".contentRateProfile").hide(),Ne=ce,ae.showModal()}),e(".copyrateprofilebtn").click(function(){e(".dialogCopyProfile").find(".contentProfile").hide(),e(".dialogCopyProfile").find(".contentRateProfile").show(),Ne=Ee,ae.showModal()}),e(".dialogCopyProfile-cancelbtn").click(function(){ae.close()}),e(".dialogCopyProfile-confirmbtn").click(function(){switch(Ne){case ce:t.COPY_PROFILE.type=ce,t.COPY_PROFILE.dstProfile=parseInt(Ie.val()),t.COPY_PROFILE.srcProfile=t.CONFIG.profile,y.send_message(u.MSP_COPY_PROFILE,K.crunch(u.MSP_COPY_PROFILE),!1,a);break;case Ee:t.COPY_PROFILE.type=Ee,t.COPY_PROFILE.dstProfile=parseInt(me.val()),t.COPY_PROFILE.srcProfile=t.CONFIG.rateProfile,y.send_message(u.MSP_COPY_PROFILE,K.crunch(u.MSP_COPY_PROFILE),!1,a);break;default:a();break}function a(){ae.close()}}),s.initialize();const Fe=1.4,Ge=.7,De=e("#sliderPidsModeSelect"),be=e("#sliderGyroFilterModeSelect"),Le=e("#sliderDTermFilterModeSelect"),Z=e('input[id="useIntegratedYaw"]');Z.on("change",()=>{Z.is(":checked")&&s.sliderPidsMode&&De.val(1).trigger("change")}),De.on("change",function(){const a=parseInt(e(this).val());s.sliderPidsMode=a,s.calculateNewPids(),s.updatePidSlidersDisplay(),a===2&&Z.prop("checked",!1).trigger("change")}),be.change(function(){parseInt(e(this).find(":selected").val())===1?s.gyroFilterSliderEnable():s.gyroFilterSliderDisable()}),Le.change(function(){parseInt(e(this).find(":selected").val())!==0?s.dtermFilterSliderEnable():s.dtermFilterSliderDisable()});const ue=e("#sliderMasterMultiplier, #sliderDGain, #sliderPIGain, #sliderFeedforwardGain, #sliderIGain, #sliderDMaxGain, #sliderRollPitchRatio, #sliderPitchPIGain");e(".tab-pid-tuning .legacySlider").hide(),ue.on("input mouseup",function(){const a=e(this);s.expertMode||(a.val()>Fe?a.val(Fe):a.val()<Ge&&a.val(Ge));const d=Be(a.val())?parseInt(a.val()):parseFloat(a.val());a.is("#sliderDGain")?s.sliderDGain=d:a.is("#sliderPIGain")?s.sliderPIGain=d:a.is("#sliderFeedforwardGain")?s.sliderFeedforwardGain=d:a.is("#sliderDMaxGain")?s.sliderDMaxGain=d:a.is("#sliderIGain")?s.sliderIGain=d:a.is("#sliderRollPitchRatio")?s.sliderRollPitchRatio=d:a.is("#sliderPitchPIGain")?s.sliderPitchPIGain=d:a.is("#sliderMasterMultiplier")&&(s.sliderMasterMultiplier=d),i.calculateNewPids(),i.analyticsChanges.PidTuningSliders="On"}),ue.each(function(a){i.sliderOnScroll(e(this))}),ue.dblclick(function(){const a=e(this);let d;a.is("#sliderDGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_d_gain/100,s.sliderDGain=d):a.is("#sliderPIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_pi_gain/100,s.sliderPIGain=d):a.is("#sliderFeedforwardGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_feedforward_gain/100,s.sliderFeedforwardGain=d):a.is("#sliderDMaxGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_dmax_gain/100,s.sliderDMaxGain=d):a.is("#sliderIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_i_gain/100,s.sliderIGain=d):a.is("#sliderRollPitchRatio")?(d=t.DEFAULT_TUNING_SLIDERS.slider_roll_pitch_ratio/100,s.sliderRollPitchRatio=d):a.is("#sliderPitchPIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_pitch_pi_gain/100,s.sliderPitchPIGain=d):a.is("#sliderMasterMultiplier")&&(d=t.DEFAULT_TUNING_SLIDERS.slider_master_multiplier/100,s.sliderMasterMultiplier=d),a.val(d),i.calculateNewPids()});const ye=e("#sliderGyroFilterMultiplier, #sliderDTermFilterMultiplier");ye.on("input mouseup",function(){const a=e(this);s.expertMode||(a.is("#sliderGyroFilterMultiplier")?a.val()>1.5?a.val(1.5):a.val()<.5&&a.val(.5):a.is("#sliderDTermFilterMultiplier")&&(a.val()>1.2?a.val(1.2):a.val()<.8&&a.val(.8)));let d=Be(a.val())?parseInt(a.val()):parseFloat(a.val());a.is("#sliderGyroFilterMultiplier")?(s.sliderGyroFilterMultiplier=d,i.calculateNewGyroFilters(),i.analyticsChanges.GyroFilterTuningSlider="On"):a.is("#sliderDTermFilterMultiplier")&&(s.sliderDTermFilterMultiplier=d,i.calculateNewDTermFilters(),i.analyticsChanges.DTermFilterTuningSlider="On")}),ye.each(function(){i.sliderOnScroll(e(this))}),ye.dblclick(function(){const a=e(this);a.val(1),a.is("#sliderGyroFilterMultiplier")?(s.sliderGyroFilterMultiplier=1,i.calculateNewGyroFilters()):a.is("#sliderDTermFilterMultiplier")&&(s.sliderDTermFilterMultiplier=1,i.calculateNewDTermFilters())}),e(".pid_filter tr:not(.newFilter) input, .pid_filter tr:not(.newFilter) select").on("input",function(a){a.target.type==="number"?e(`.pid_filter input[name="${a.target.name}"]`).val(a.target.value):a.target.type==="select-one"&&e(`.pid_filter select[name="${a.target.name}"]`).val(a.target.value),s.GyroSliderUnavailable&&(i.analyticsChanges.GyroFilterTuningSlider="Off"),s.DTermSliderUnavailable&&(i.analyticsChanges.DTermFilterTuningSlider="Off")}),e(".pid_filter tr:not(.newFilter) .inputSwitch input").change(()=>{e(".pid_filter input").triggerHandler("input"),i.setDirty(!0)}),e(".tuningHelp").hide(),e("#pid-tuning .delta select").change(function(){i.setDirty(!0)}),e("a.update").click(function(){T(),i.updating=!0,y.promise(u.MSP_SET_PID,K.crunch(u.MSP_SET_PID)).then(()=>y.promise(u.MSP_SET_PID_ADVANCED,K.crunch(u.MSP_SET_PID_ADVANCED))).then(()=>L.gte(t.CONFIG.apiVersion,k)?y.promise(u.MSP2_SET_TEXT,K.crunch(u.MSP2_SET_TEXT,u.PID_PROFILE_NAME)):!0).then(()=>L.gte(t.CONFIG.apiVersion,k)?y.promise(u.MSP2_SET_TEXT,K.crunch(u.MSP2_SET_TEXT,u.RATE_PROFILE_NAME)):!0).then(()=>(i.updatePIDColors(),y.promise(u.MSP_SET_FILTER_CONFIG,K.crunch(u.MSP_SET_FILTER_CONFIG)))).then(()=>y.promise(u.MSP_SET_RC_TUNING,K.crunch(u.MSP_SET_RC_TUNING))).then(()=>y.promise(u.MSP_SET_FEATURE_CONFIG,K.crunch(u.MSP_SET_FEATURE_CONFIG))).then(()=>y.promise(u.MSP_SET_SIMPLIFIED_TUNING,K.crunch(u.MSP_SET_SIMPLIFIED_TUNING))).then(()=>y.promise(u.MSP_EEPROM_WRITE)).then(()=>{i.updating=!1,i.setDirty(!1),Se(E.getMessage("pidTuningEepromSaved")),i.refresh()}),je.sendSaveAndChangeEvents(je.EVENT_CATEGORIES.FLIGHT_CONTROLLER,i.analyticsChanges,"pid_tuning"),i.analyticsChanges={}}),i.initRatesPreview(),i.renderModel(),i.updating=!1,Re.interval_add("receiver_pull",i.getReceiverData,250,!0),Re.interval_add("update_profile",function(){i.checkUpdateProfile(!0)},500,!0),i.analyticsChanges={},Re.content_ready(r),Ue.pid_tuning.isHtmlProcessing=!1}};A.getReceiverData=function(){y.send_message(u.MSP_RC,!1,!1)};A.initRatesPreview=function(){this.keepRendering=!0,this.model=new at(e(".rates_preview"),e(".rates_preview canvas")),e(".tab-pid_tuning .tab-container .rates").on("click",e.proxy(this.model.resize,this.model)),e(".tab-pid_tuning .tab-container .rates").on("click",e.proxy(this.updateRatesLabels,this)),e(window).on("resize",e.proxy(this.model.resize,this.model)),e(window).on("resize",e.proxy(this.updateRatesLabels,this))};A.renderModel=function(){if(this.keepRendering&&(requestAnimationFrame(this.renderModel.bind(this)),this.clock||(this.clock=new nt),t.RC.channels[0]&&t.RC.channels[1]&&t.RC.channels[2])){const r=this.clock.getDelta(),i=r*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[0],this.currentRates.roll_rate,this.currentRates.rc_rate,this.currentRates.rc_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.roll_rate_limit),o=r*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[1],this.currentRates.pitch_rate,this.currentRates.rc_rate_pitch,this.currentRates.rc_pitch_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.pitch_rate_limit),c=r*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[2],this.currentRates.yaw_rate,this.currentRates.rc_rate_yaw,this.currentRates.rc_yaw_expo,this.currentRates.superexpo,this.currentRates.yawDeadband,this.currentRates.yaw_rate_limit);this.model.rotateBy(-$e(o),-$e(c),-$e(i)),this.checkRC()&&this.updateRatesLabels()}};A.cleanup=function(r){const i=this;i.keepRendering=!1,i.model&&(e(window).off("resize",e.proxy(i.model.resize,i.model)),i.model.dispose()),e(window).off("resize",e.proxy(this.updateRatesLabels,this)),i.throttleDrawInterval&&clearInterval(i.throttleDrawInterval),r&&r()};A.refresh=function(r){const i=this;Re.tab_switch_cleanup(function(){i.initialize(),i.setDirty(!1),r&&r()})};A.setProfile=function(){const r=this;r.currentProfile=t.CONFIG.profile,e('.tab-pid_tuning select[name="profile"]').val(r.currentProfile)};A.setRateProfile=function(){const r=this;r.currentRateProfile=t.CONFIG.rateProfile,e('.tab-pid_tuning select[name="rate_profile"]').val(r.currentRateProfile)};A.setDirty=function(r){const i=this;i.dirty=r,e('.tab-pid_tuning select[name="profile"]').prop("disabled",r),e('.tab-pid_tuning select[name="rate_profile"]').prop("disabled",r)};A.checkUpdateProfile=function(r){const i=this;if(Re.active_tab==="pid_tuning"&&!i.updating&&!i.dirty){let o=!1;i.currentProfile!==t.CONFIG.profile&&(i.setProfile(),o=!0);let c=!1;r&&i.currentRateProfile!==t.CONFIG.rateProfile&&(i.setRateProfile(),c=!0),(o||c)&&(i.updating=!0,i.refresh(function(){i.updating=!1,o&&(Se(E.getMessage("pidTuningReceivedProfile",[t.CONFIG.profile+1])),t.CONFIG.profile=i.currentProfile),c&&(Se(E.getMessage("pidTuningReceivedRateProfile",[t.CONFIG.rateProfile+1])),t.CONFIG.rateProfile=i.currentRateProfile)}))}};A.checkRC=function(){this.oldRC||(this.oldRC=[t.RC.channels[0],t.RC.channels[1],t.RC.channels[2]]);let r=!1;for(let i=0;i<this.oldRC.length;i++)this.oldRC[i]!==t.RC.channels[i]&&(this.oldRC[i]=t.RC.channels[i],r=!0);return r};A.checkThrottle=function(){if(!this.oldThrottle)return this.oldThrottle=t.RC.channels[3],!0;const r=this.oldThrottle!==t.RC.channels[3];return this.oldThrottle=t.RC.channels[3],r};A.updatePidControllerParameters=function(){e(".pid_tuning .YAW_JUMP_PREVENTION").hide(),e("#pid-tuning .dtermSetpointTransition").hide(),e("#pid-tuning .dtermSetpoint").hide(),e("#pid-tuning .delta").hide()};A.updateRatesLabels=function(){const r=this;if(!r.rateCurve.useLegacyCurve&&r.rateCurve.maxAngularVel){const i=function(n,T,_,p,R,M){n.fillStyle=M||"#888888",n.textAlign=R||"center",n.fillText(T,_,p)},o=function(n,T,_,p,R,M,F){const m=parseInt(n.font),h=n.measureText(T).width*1.2,I=m*1.5,C=p;n.fillStyle=M.color||"#ffffff",n.strokeStyle=M.border||"#000000",_*=n.canvas.clientWidth/n.canvas.clientHeight,_+=(R=="right"?-(h+125):0)+(R=="left"?125:0),p-=I/2,p<0?p=0:p>n.height&&(p=n.height);for(let G=0;G<F.length;G++)(_>=F[G].left&&_<=F[G].right||_+h>=F[G].left&&_+h<=F[G].right)&&(p>=F[G].top&&p<=F[G].bottom||p+I>=F[G].top&&p+I<=F[G].bottom)&&(p<=(F[G].bottom-F[G].top)/2&&F[G].top-I>0?p=F[G].top-I:p=F[G].bottom);F.push({left:_,right:_+h,top:p-5,bottom:p+I+5});const w=(I-2*10)/6;n.beginPath(),n.moveTo(_+10,p),n.lineTo(_+h-10,p),n.quadraticCurveTo(_+h,p,_+h,p+10),R==="right"&&(n.lineTo(_+h,p+10+w),n.lineTo(_+h+125,C),n.lineTo(_+h,p+I-10-w)),n.lineTo(_+h,p+I-10),n.quadraticCurveTo(_+h,p+I,_+h-10,p+I),n.lineTo(_+10,p+I),n.quadraticCurveTo(_,p+I,_,p+I-10),R==="left"&&(n.lineTo(_,p+I-10-w),n.lineTo(_-125,C),n.lineTo(_,p+10-w)),n.lineTo(_,p+10),n.quadraticCurveTo(_,p,_+10,p),n.closePath(),n.fill(),n.stroke(),i(n,T,_+h/2,p+(I+m)/2-4,"center",M.text)},c={roll:{color:"rgba(255,128,128,0.4)",border:"rgba(255,128,128,0.6)",text:"#000000"},pitch:{color:"rgba(128,255,128,0.4)",border:"rgba(128,255,128,0.6)",text:"#000000"},yaw:{color:"rgba(128,128,255,0.4)",border:"rgba(128,128,255,0.6)",text:"#000000"}},g=e(".rate_curve canvas#rate_curve_layer1").get(0);if(g){let ee=function(P){return Y-Math.ceil(n.measureText(P).width)/(n.canvas.clientWidth/n.canvas.clientHeight)-40};g.width=1e3,g.height=1e3;const n=g.getContext("2d");n.save();const T=`${r.maxAngularVelRollElement.text()} deg/s`,_=`${r.maxAngularVelPitchElement.text()} deg/s`,p=`${r.maxAngularVelYawElement.text()} deg/s`;let R=[],M=[];const F=g.height,Y=g.width,q=r.rateCurve.maxAngularVel,pe=400/n.canvas.clientHeight,m=F/2/q,h=n.canvas.width/n.canvas.clientWidth,I=n.canvas.clientHeight/n.canvas.clientWidth;n.clearRect(0,0,Y,F),pe<=1?n.font="24pt Verdana, Arial, sans-serif":n.font=`${24*pe}pt Verdana, Arial, sans-serif`,t.RC.channels[0]&&t.RC.channels[1]&&t.RC.channels[2]?(R.push(`${r.rateCurve.drawStickPosition(t.RC.channels[0],r.currentRates.roll_rate,r.currentRates.rc_rate,r.currentRates.rc_expo,r.currentRates.superexpo,r.currentRates.deadband,r.currentRates.roll_rate_limit,q,n,"#FF8080")} deg/s`),R.push(`${r.rateCurve.drawStickPosition(t.RC.channels[1],r.currentRates.pitch_rate,r.currentRates.rc_rate_pitch,r.currentRates.rc_pitch_expo,r.currentRates.superexpo,r.currentRates.deadband,r.currentRates.pitch_rate_limit,q,n,"#80FF80")} deg/s`),R.push(`${r.rateCurve.drawStickPosition(t.RC.channels[2],r.currentRates.yaw_rate,r.currentRates.rc_rate_yaw,r.currentRates.rc_yaw_expo,r.currentRates.superexpo,r.currentRates.yawDeadband,r.currentRates.yaw_rate_limit,q,n,"#8080FF")} deg/s`)):R=[],n.lineWidth=h,n.scale(I,1),i(n,`${q.toFixed(0)} deg/s`,(Y/2-10)/I,parseInt(n.font)*1.2,"right"),M=[];const C=[{value:parseInt(T),balloon:function(){o(n,T,Y,m*(q-parseInt(T)),"right",c.roll,M)}},{value:parseInt(_),balloon:function(){o(n,_,Y,m*(q-parseInt(_)),"right",c.pitch,M)}},{value:parseInt(p),balloon:function(){o(n,p,Y,m*(q-parseInt(p)),"right",c.yaw,M)}}],w=1800,G=parseInt(T)>w||parseInt(_)>w||parseInt(p)>w;e(".maxRateWarning").toggle(G),C.sort(function(P,X){return X.value-P.value}),R[0]&&R[1]&&R[2]&&C.push({value:parseInt(R[0]),balloon:function(){o(n,R[0],10,150,"none",c.roll,M)}},{value:parseInt(R[1]),balloon:function(){o(n,R[1],10,250,"none",c.pitch,M)}},{value:parseInt(R[2]),balloon:function(){o(n,R[2],10,350,"none",c.yaw,M)}});const V=e("#pid-tuning .pid_titlebar .centerSensitivity"),v=r.currentRatesType===t.RATES_TYPE.Ovobot;V.toggle(v),r.acroCenterSensitivityRollElement.toggle(v),r.acroCenterSensitivityPitchElement.toggle(v),r.acroCenterSensitivityYawElement.toggle(v),e("#pid-tuning .pid_titlebar .maxVel").toggle(!v),r.maxAngularVelRollElement.toggle(!v),r.maxAngularVelPitchElement.toggle(!v),r.maxAngularVelYawElement.toggle(!v);const z=t.ADVANCED_TUNING.levelAngleLimit,S=parseInt(T),j=parseInt(_),B=parseInt(p),O=r.currentRates.rc_rate,Q=r.currentRates.rc_rate_pitch,se=r.currentRates.rc_rate_yaw,J="Angle Mode";if(r.currentRatesType===t.RATES_TYPE.ACTUAL){i(n,J,(Y-10)/I,F-250,"right");const P=(O/S*z).toFixed(1),X=(Q/j*z).toFixed(1),H=`${P}...${z}`,oe=`${X}...${z}`,le=ee(H),ae=ee(oe);C.push({value:parseInt(P),balloon:function(){o(n,H,le,F-150,"none",c.roll,M)}},{value:parseInt(X),balloon:function(){o(n,oe,ae,F-50,"none",c.pitch,M)}})}if(r.currentRatesType===t.RATES_TYPE.Ovobot){i(n,J,(Y-10)/I,F-250,"right");const P=14.54,X=Z=>Z>2?(Z-2)*P+2:Z,H=(Z,ue)=>((1-Z)*X(ue)*200).toFixed(0),oe=(Z,ue)=>(z*((1-Z)*X(ue)*200/S)).toFixed(1),le=r.currentRates.rc_expo,ae=oe(le,O),ce=`${ae} - ${z}`,Ee=ee(ce),Ne=H(le,O);r.acroCenterSensitivityRollElement.text(`${Ne} - ${S}`);const Ie=r.currentRates.rc_pitch_expo,me=oe(Ie,Q),Fe=`${me} - ${z}`,Ge=ee(Fe),De=H(Ie,Q);r.acroCenterSensitivityPitchElement.text(`${De} - ${j}`);const be=r.currentRates.rc_yaw_expo,Le=H(be,se);r.acroCenterSensitivityYawElement.text(`${Le} - ${B}`),C.push({value:parseInt(ae),balloon:function(){o(n,ce,Ee,F-150,"none",c.roll,M)}},{value:parseInt(me),balloon:function(){o(n,Fe,Ge,F-50,"none",c.pitch,M)}})}for(const P of C)P.balloon();n.restore()}}};A.calculateNewPids=function(){Ue.pid_tuning.isHtmlProcessing||s.calculateNewPids()};A.calculateNewGyroFilters=function(){Ue.pid_tuning.isHtmlProcessing||s.sliderGyroFilter&&s.calculateNewGyroFilters()};A.calculateNewDTermFilters=function(){Ue.pid_tuning.isHtmlProcessing||s.sliderDTermFilter&&s.calculateNewDTermFilters()};A.updateFilterWarning=function(){const r=parseInt(e('.pid_filter select[name="gyroLowpassFilterMode"]').val()),i=r===1,o=!r,c=parseInt(e('.pid_filter select[name="dtermLowpassFilterMode"]').val()),g=c===1,n=!c,T=e("#pid-tuning .filterWarning"),_=e("#pid-tuning .dynamicNotchNyquistWarningNote");T.toggle(!(i||o)||!(g||n)),_.toggle(t.CONFIG.sampleRateHz/t.PID_ADVANCED_CONFIG.pid_process_denom<2e3)};A.updatePIDColors=function(r=!1){if(L.gte(t.CONFIG.apiVersion,"1.44.0"))return;const i=function(o,c,g){if(r){o.css({"background-color":"transparent"});return}if(g===void 0||c===void 0)return;const n=(g-c)/50;o.css({"background-color":st(n,Je.pidSlider)})};t.PID_NAMES.forEach(function(o,c){e(`.pid_tuning .${o} input`).each(function(g){i(e(this),t.PIDS_ACTIVE[c][g],t.PIDS[c][g])})}),i(e('.pid_tuning input[name="dMaxRoll"]'),t.ADVANCED_TUNING_ACTIVE.dMaxRoll,t.ADVANCED_TUNING.dMaxRoll),i(e('.pid_tuning input[name="dMaxPitch"]'),t.ADVANCED_TUNING_ACTIVE.dMaxPitch,t.ADVANCED_TUNING.dMaxPitch),i(e('.pid_tuning input[name="dMaxYaw"]'),t.ADVANCED_TUNING_ACTIVE.dMaxYaw,t.ADVANCED_TUNING.dMaxYaw),i(e('.pid_tuning .ROLL input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardRoll,t.ADVANCED_TUNING.feedforwardRoll),i(e('.pid_tuning .PITCH input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardPitch,t.ADVANCED_TUNING.feedforwardPitch),i(e('.pid_tuning .YAW input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardYaw,t.ADVANCED_TUNING.feedforwardYaw)};A.changeRatesType=function(r){const i=this,o=e(".dialogRatesType")[0];if(i.previousRatesType==null){i.currentRatesType=r,i.changeRatesTypeLogo(),i.changeRatesSystem(!0),i.previousRatesType=i.currentRatesType;return}o.hasAttribute("open")||(o.showModal(),e(".dialogRatesType-cancelbtn").click(function(){e('.rates_type select[id="ratesType"]').val(i.currentRatesType),i.previousRatesType=i.currentRatesType,o.close()}),e(".dialogRatesType-confirmbtn").click(function(){i.currentRatesType=r,i.changeRatesTypeLogo(),i.changeRatesSystem(!1),i.previousRatesType=i.currentRatesType,o.close(),t.RC_TUNING.rates_type=i.currentRatesType,i.currentRates=i.rateCurve.getCurrentRates()}))};A.changeRatesSystem=function(r){const i=this;let o=2.55,c=.01,g=.01,n=1,T=.01,_=1,p=.01,R=0;const M=0,F=e('.pid_tuning input[name="pitch_rate"]'),Y=e('.pid_tuning input[name="roll_rate"]'),q=e('.pid_tuning input[name="yaw_rate"]'),pe=e('.pid_tuning input[name="rc_rate_pitch"]'),m=e('.pid_tuning input[name="rc_rate"]'),h=e('.pid_tuning input[name="rc_rate_yaw"]'),I=e('.pid_tuning input[name="rc_pitch_expo"]'),C=e('.pid_tuning input[name="rc_expo"]'),w=e('.pid_tuning input[name="rc_yaw_expo"]'),G=e("#pid-tuning .pid_titlebar .rc_rate"),V=e("#pid-tuning .pid_titlebar .rate"),v=e("#pid-tuning .pid_titlebar .rc_expo"),z=e("#pid-tuning .pid_titlebar .centerSensitivity");let S=1 .toFixed(2),j=.7.toFixed(2),B=0 .toFixed(2);switch(r&&(F.val(t.RC_TUNING.pitch_rate.toFixed(2)),Y.val(t.RC_TUNING.roll_rate.toFixed(2)),q.val(t.RC_TUNING.yaw_rate.toFixed(2)),pe.val(t.RC_TUNING.rcPitchRate.toFixed(2)),m.val(t.RC_TUNING.RC_RATE.toFixed(2)),h.val(t.RC_TUNING.rcYawRate.toFixed(2)),I.val(t.RC_TUNING.RC_PITCH_EXPO.toFixed(2)),C.val(t.RC_TUNING.RC_EXPO.toFixed(2)),w.val(t.RC_TUNING.RC_YAW_EXPO.toFixed(2))),i.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:G.text(E.getMessage("pidTuningRcRateRaceflight")),V.text(E.getMessage("pidTuningRateRaceflight")),v.text(E.getMessage("pidTuningRcExpoRaceflight")),o=2e3,c=10,g=10,n=255,T=1,_=100,p=1,r?(F.val((t.RC_TUNING.pitch_rate*100).toFixed(0)),Y.val((t.RC_TUNING.roll_rate*100).toFixed(0)),q.val((t.RC_TUNING.yaw_rate*100).toFixed(0)),pe.val((t.RC_TUNING.rcPitchRate*1e3).toFixed(0)),m.val((t.RC_TUNING.RC_RATE*1e3).toFixed(0)),h.val((t.RC_TUNING.rcYawRate*1e3).toFixed(0)),I.val((t.RC_TUNING.RC_PITCH_EXPO*100).toFixed(0)),C.val((t.RC_TUNING.RC_EXPO*100).toFixed(0)),w.val((t.RC_TUNING.RC_YAW_EXPO*100).toFixed(0))):(S=370 .toFixed(0),j=80 .toFixed(0),B=50 .toFixed(0));break;case t.RATES_TYPE.KISS:G.text(E.getMessage("pidTuningRcRate")),V.text(E.getMessage("pidTuningRcRateRaceflight")),v.text(E.getMessage("pidTuningRcExpoKISS")),n=.99;break;case t.RATES_TYPE.ACTUAL:G.text(E.getMessage("pidTuningRcRateActual")),V.text(E.getMessage("pidTuningRateQuickRates")),v.text(E.getMessage("pidTuningRcExpoRaceflight")),R=10,n=2e3,T=10,o=2e3,c=10,g=10,r?(F.val((t.RC_TUNING.pitch_rate*1e3).toFixed(0)),Y.val((t.RC_TUNING.roll_rate*1e3).toFixed(0)),q.val((t.RC_TUNING.yaw_rate*1e3).toFixed(0)),pe.val((t.RC_TUNING.rcPitchRate*1e3).toFixed(0)),m.val((t.RC_TUNING.RC_RATE*1e3).toFixed(0)),h.val((t.RC_TUNING.rcYawRate*1e3).toFixed(0))):(S=70 .toFixed(0),j=670 .toFixed(0),B=0 .toFixed(2));break;case t.RATES_TYPE.QUICKRATES:G.text(E.getMessage("pidTuningRcRate")),V.text(E.getMessage("pidTuningRateQuickRates")),v.text(E.getMessage("pidTuningRcExpoRaceflight")),R=10,n=2e3,T=10,r?(F.val((t.RC_TUNING.pitch_rate*1e3).toFixed(0)),Y.val((t.RC_TUNING.roll_rate*1e3).toFixed(0)),q.val((t.RC_TUNING.yaw_rate*1e3).toFixed(0))):j=670 .toFixed(0);break;default:G.text(E.getMessage("pidTuningRcRate")),V.text(E.getMessage("pidTuningRate")),v.text(E.getMessage("pidTuningRcExpo")),z.text(E.getMessage("pidTuningAcroCenterSensitiviy"));break}const O=e('#pid-tuning input[class="rc_rate_input"]'),Q=e('#pid-tuning input[class="rate_input"]'),se=e('#pid-tuning input[class="expo_input"]');r||(Q.val(j),O.val(S),se.val(B)),O.attr({max:o,min:c,step:g}).change(),Q.attr({max:n,min:R,step:T}).change(),se.attr({max:_,min:M,step:p}).change(),r&&i.setDirty(!1)};A.changeRatesTypeLogo=function(){const r=this,i=e('.rates_type img[id="ratesLogo"]');switch(r.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:i.attr("src","./images/rate_logos/raceflight.svg");break;case t.RATES_TYPE.KISS:i.attr("src","./images/rate_logos/kiss.svg");break;case t.RATES_TYPE.ACTUAL:i.attr("src","./images/rate_logos/actual.svg");break;case t.RATES_TYPE.QUICKRATES:i.attr("src","./images/rate_logos/quickrates.svg");break;default:i.attr("src","./images/rate_logos/Ovobot.svg");break}};A.expertModeChanged=function(r){s.setExpertMode(r)};A.sliderOnScroll=function(r,i){r.parent().on("input wheel",function(o){var _,p;if(r.prop("disabled")||!((_=o.originalEvent)!=null&&_.deltaY&&((p=o.originalEvent)!=null&&p.altKey)))return;o.preventDefault();const c=parseFloat(r.attr("step")),g=o.originalEvent.deltaY>0?-c:c,n=Be(r.val())?parseInt(r.val()):parseFloat(r.val()),T=(Math.floor(n*100)+Math.floor(g*100))/100;r.val(T),r.trigger("input"),r.trigger("change")})};Ue.pid_tuning=A;export{A as pid_tuning};
