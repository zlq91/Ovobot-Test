import{G as A,T as ue,F as e,I as r,C as Qe,a9 as _e,M as n,X as o}from"./DarkTheme-gFe2bpMP.js";const ae={yaw_fix:0,sampleCnt:0,sampleAccCnt:0,bufLen:30,sampleWheel:0,sampleFan:0,adcBufLen:20},a={tr_red:"rgb(187,27,27)",tr_green:"rgb(43, 144, 43)"},B={BATT_CHG_MODE_NONE:0,BATT_CHG_MODE_SLOW:1,BATT_CHG_MODE_FAST:2,BATT_CHG_MODE_CONST_VOLT:3,BATT_CHG_MODE_FULL:4};ae.initialize=function(P){const s=this;A.active_tab!="setup"&&(A.active_tab="setup");function Ae(){e.CONFIG.hw==3||e.CONFIG.hw==2?$("#content").load("./tabs/ecs_setup.html",ee):$("#content").load("./tabs/setup.html",ee)}function m(c,f){return(c>>f&1)!=1}Ae();let v=Array.from({length:s.bufLen}),V=Array.from({length:s.bufLen}),W=Array.from({length:s.bufLen}),U=Array.from({length:s.bufLen}),H=Array.from({length:s.bufLen}),Y=Array.from({length:s.bufLen}),G=Array.from({length:s.adcBufLen}),R=Array.from({length:s.adcBufLen}),F=Array.from({length:s.adcBufLen}),O=!1,D=!1,p=0,l=0,T=-1,X=!0,z=!1,C=!1,M=!1,b=0;const Z=2;let E=!1,y=0;const J=20;let K=!1,N=!1,Q=!1,x=!1,se=0,le=0,re=0,j=!0;function be(){l==0&&(p=0,l=1)}function Se(c,f,g){for(let _=0;_<s.bufLen-1;_++)v[_]=v[_+1],V[_]=V[_+1],W[_]=W[_+1];return v[s.bufLen-1]=c,V[s.bufLen-1]=f,W[s.bufLen-1]=g,s.sampleCnt>s.bufLen?1:(s.sampleCnt++,0)}function Oe(c,f,g){for(let _=0;_<s.bufLen-1;_++)U[_]=U[_+1],H[_]=H[_+1],Y[_]=Y[_+1];return U[s.bufLen-1]=c,H[s.bufLen-1]=f,Y[s.bufLen-1]=g,s.sampleAccCnt>s.bufLen?1:(s.sampleAccCnt++,0)}function ne(c,f){for(let g=0;g<s.adcBufLen-1;g++)G[g]=G[g+1],R[g]=R[g+1];return G[s.adcBufLen-1]=c,R[s.adcBufLen-1]=f,s.sampleWheel>s.adcBufLen?1:(s.sampleWheel++,0)}function Te(c){for(let f=0;f<s.adcBufLen-1;f++)F[f]=F[f+1];return F[s.adcBufLen-1]=c,s.sampleFan>s.adcBufLen?1:(s.sampleFan++,0)}function S(c){const f=$(".dialogError")[0];$(".dialogError-content").html(c),$(".dialogError-closebtn").click(function(){f.close()}),f.showModal()}function me(){const c=$(".dialogSprayConfirm")[0];$(".dialogSprayConfirm-confirmbtn").click(function(){j=!1,c.close()}),$(".dialogSprayConfirm-cancelbtn").click(function(){j=!1,c.close()}),c.showModal()}function oe(c){const f=$(".dialogTestSpray")[0];$(".dialogTestSpray-content").html(c),$(".dialogTestSpray-spraybtn").click(function(){n.send_message(o.MSP_SET_SPRAY,[1],!1,!1),f.close(),me()}),$(".dialogTestSpray-closebtn").click(function(){f.close()}),f.showModal()}function pe(){$(".dialogAutoTest")[0].close()}function Ne(c){const f=$(".dialogAutoTest")[0];$(".dialogAutoTestTitle").html(c),f.showModal()}function ie(c){$(".dialogAutoTestTitle").html(c)}function q(c){const f=$(".dialogTestFourCorner")[0];$(".dialogTestFourCornerTitle").html(c),$(".dialogTestFourCorner-closebtn").click(function(){pe(),l=0,s.sampleCnt=0,s.sampleAccCnt=0,f.close()}),f.showModal()}function ce(){$(".dialogTestFourCorner")[0].close()}function ee(){r.localizePage();const c=$("#content .backup");Qe.virtualMode&&c.addClass("disabled"),$("span.roll").text(r.getMessage("initialSetupAttitude",[0])),$("span.pitch").text(r.getMessage("initialSetupAttitude",[0])),$("span.heading").text(r.getMessage("initialSetupAttitude",[0])),_e(e.CONFIG.activeSensors,"acc")||($("a.calibrateAccel").addClass("disabled"),$("default_btn").addClass("disabled")),_e(e.CONFIG.activeSensors,"mag")||($("a.calibrateMag").addClass("disabled"),$("default_btn").addClass("disabled")),$("#arming-disable-flag").attr("title",r.getMessage("initialSetupArmingDisableFlagsTooltip")),$("a.calibrateAccel").click(function(){const i=$(this);i.hasClass("calibrating")||(i.addClass("calibrating"),A.interval_pause("setup_data_pull"),n.send_message(o.MSP_ACC_CALIBRATION,!1,!1,function(){A.log(r.getMessage("initialSetupAccelCalibStarted")),$("#accel_calib_running").show(),$("#accel_calib_rest").hide()}),A.timeout_add("button_reset",function(){A.interval_resume("setup_data_pull"),A.log(r.getMessage("initialSetupAccelCalibEnded")),i.removeClass("calibrating"),$("#accel_calib_running").hide(),$("#accel_calib_rest").show()},2e3))}),$("a.calibrateMag").click(function(){const i=$(this);!i.hasClass("calibrating")&&!i.hasClass("disabled")&&(i.addClass("calibrating"),n.send_message(o.MSP_MAG_CALIBRATION,!1,!1,function(){A.log(r.getMessage("initialSetupMagCalibStarted")),$("#mag_calib_running").show(),$("#mag_calib_rest").hide()}),A.timeout_add("button_reset",function(){A.log(r.getMessage("initialSetupMagCalibEnded")),i.removeClass("calibrating"),$("#mag_calib_running").hide(),$("#mag_calib_rest").show()},3e4))});const f=$(".dialogConfirmReset")[0],g=$(".dialogAutoTest")[0];$(".dialogAutoTest-closebtn").click(function(){l=0,s.sampleCnt=0,s.sampleAccCnt=0,g.close()}),$(".dialogTestFourCorner")[0],$("a.autoTestPCB").click(function(){f.showModal()}),$("a.clockwise").click(function(){n.send_message(o.MSP_SET_MOTOR,[1],!1,function(){})}),$("a.anti_clockwise").click(function(){n.send_message(o.MSP_SET_MOTOR,[2],!1,function(){})}),$("a.nextVoice").click(function(){n.send_message(o.MSP_PLAY_VOICE,[1],!1,function(){})}),$("a.preVoice").click(function(){n.send_message(o.MSP_PLAY_VOICE,[0],!1,function(){})}),$("a.playVoiceIndex").click(function(){const i=$('input[name="voice-number"]').val();n.send_message(o.MSP_PLAY_VOICE,[i],!1,function(){})}),$("a.stop").click(function(){n.send_message(o.MSP_SET_MOTOR,[0],!1,function(){})}),$("a.spray").click(function(){n.send_message(o.MSP_SET_SPRAY,[1],!1,!1)}),$("a.accCali").click(function(){n.send_message(o.MSP_ACC_CALIBRATION,!1,!1,function(){})}),$("a.wifitest").click(function(){e.ANALOG.rssi=0,n.send_message(o.MSP_WIFI_TEST,!1,!1,function(){})}),$("#sliderGyroFilterMultiplier").val(0),$("#sliderGyroFilterMultiplier").on("input",function(){const i=$(this).val();n.send_message(o.MSP_SET_FAN,[i],!1,function(){})}),$("div.permanentExpertMode input").prop("checked",!1),$("div.permanentExpertMode input").change(function(){$(this).is(":checked")?n.send_message(o.MSP_SET_FAN,[60],!1,function(){O=!0}):n.send_message(o.MSP_SET_FAN,[0],!1,function(){O=!1})}),$("div.permanentExpertMode2 input").prop("checked",!1),$("div.permanentExpertMode2 input").change(function(){$(this).is(":checked")?n.send_message(o.MSP_SET_BRUSH,[50],!1,function(){}):n.send_message(o.MSP_SET_BRUSH,[0],!1,function(){})}),$(".program_version").text([e.CONFIG.firmwareVersion]),$(".dialogConfirmReset-cancelbtn").click(function(){f.close()}),$(".dialogConfirmReset-confirmbtn").click(function(){j=!0,f.close(),l=0,s.sampleCnt=0,s.sampleAccCnt=0,O=!1,be(),Ne(r.getMessage("dialogAutoTestGyroAccTitle"))}),$("div#interactive_block > a.reset").text(r.getMessage("initialSetupButtonResetZaxisValue",[s.yaw_fix])),$("div#interactive_block > a.reset").click(function(){s.yaw_fix=e.SENSOR_DATA.kinematics[2]*-1,$(this).text(r.getMessage("initialSetupButtonResetZaxisValue",[s.yaw_fix])),console.log(`YAW reset to 0 deg, fix: ${s.yaw_fix} deg`)}),c.click(function(){$(this).hasClass("disabled")||configuration_backup(function(){A.log(r.getMessage("initialSetupBackupSuccess"))})}),$("#content .restore").click(function(){$(this).hasClass("disabled")||configuration_restore(function(){ue.setup.initialize(),A.log(r.getMessage("initialSetupRestoreSuccess"))})}),$('input[name="voice-number"]').val(2).trigger("input");const he=$(".leftAdc"),ye=$(".rightAdc"),Ce=$(".fanAdc"),Me=$(".battAdc"),Ee=$(".adapterAdc"),ke=$(".waterboxAdc"),$e=$(".attiYaw"),Le=$(".baroVal"),Ge=$(".cornerULVal"),Re=$(".cornerURVal"),Fe=$(".cornerBLVal"),De=$(".cornerBRVal"),xe=$(".collisionULVal"),we=$(".collisionURVal"),Ie=$(".collisionBLVal"),Be=$(".collisionBRVal"),Pe=$(".gyroXData"),ve=$(".gyroYData"),Ve=$(".gyroZData"),We=$(".accXData"),Ue=$(".accYData"),He=$(".accZData"),te=$(".wifiRssiValue"),Ye=$(".baroOriginalValue"),Xe=$(".baroStandardValue"),ze=$(".arming-disable-flags"),Ze=$(".battStatusVal"),Ke=$(".battVoltageVal"),je=$(".battChgCurrentVal"),k=function(i){let t=0;for(let u=0;u<i.length;u++)t+=i[u];return t/i.length},L=function(i){let t=0,d=i[0];for(let u=1;u<i.length;u++)d==i[u]&&(t+=1),d=i[u];return t==i.length-1};(function(){let i=["NO_GYRO","FAILSAFE","RX_FAILSAFE","BAD_RX_RECOVERY","BOXFAILSAFE","THROTTLE","ANGLE","BOOT_GRACE_TIME","NOPREARM","LOAD","CALIBRATING","CLI","CMS_MENU","OSD_MENU","BST","MSP"];i=i.concat(["ARM_SWITCH"]),ze.append('<span id="initialSetupArmingAllowed" i18n="initialSetupArmingAllowed" style="display: none;"></span>')})();function qe(){const t=$(".cf_table tbody").find("tr");e.CONFIG.hw==2&&n.send_message(o.MSP_BATTERY,!1,!1,function(){Me.text(r.getMessage("battAdcValue",[e.ANALOG.batt])),e.ANALOG.batt>=12&&e.ANALOG.batt<=18?(K=!1,t[3].style.background=a.tr_green):(K=!0,t[3].style.background=a.tr_red),l==3&&(K?(l=0,g.close(),S(K)):l=4)}),n.send_message(o.MSP_ATTITUDE,!1,!1,function(){t[6].style.background=a.tr_green,$e.text(e.SENSOR_DATA.kinematics[0]+" °")}),e.ANALOG.rssi==0&&(t[18].style.background="none"),n.send_message(o.MSP_WIFI_RSSI,!1,!1,function(){if(e.ANALOG.rssi==1)t[18].style.background=a.tr_red,te.text("WIFI 没扫描到无线设备");else if(e.ANALOG.rssi==2)t[18].style.background=a.tr_red,te.text("WIFI模块未授权");else if(e.ANALOG.rssi>2){t[18].style.background=a.tr_green;const d=e.ANALOG.rssi-3;te.text(d)}}),n.send_message(o.MSP_ADAPTER,!1,!1,function(){Ee.text(e.ANALOG.adapter+" V"),e.ANALOG.adapter>=22&&e.ANALOG.adapter<=26?(N=!1,t[4].style.background=a.tr_green):(N=!0,t[4].style.background=a.tr_red),l==4&&(N?(l=0,g.close(),S(N)):e.CONFIG.hw==3?(l=6,T=0,b=Z,C=!1,M=!1,s.sampleWheel=0,z=!1,y=J,s.sampleFan=0,D=!1,E=!1):e.CONFIG.hw==2&&(l=5))}),n.send_message(o.MSP_WATER_BOX,!1,!1,function(){ke.text(e.ANALOG.waterstate),e.ANALOG.waterstate==1?t[5].style.background=a.tr_green:t[5].style.background=a.tr_red}),n.send_message(o.MSP_FOURCORNER,!1,!1,function(){const d=m(e.ANALOG.corner,3)?0:1,u=m(e.ANALOG.corner,2)?0:1,w=m(e.ANALOG.corner,1)?0:1,I=m(e.ANALOG.corner,0)?0:1;if(Ge.text(d),Re.text(u),Fe.text(w),De.text(I),d==0?t[8].style.background=a.tr_red:t[8].style.background=a.tr_green,u==0?t[9].style.background=a.tr_red:t[9].style.background=a.tr_green,w==0?t[10].style.background=a.tr_red:t[10].style.background=a.tr_green,I==0?t[11].style.background=a.tr_red:t[11].style.background=a.tr_green,e.CONFIG.isCollision==1){$("#collisionval_table").parent().parent().removeClass("model-display");const h=m(e.ANALOG.hitCorner,3)?0:1,fe=m(e.ANALOG.hitCorner,2)?0:1,de=m(e.ANALOG.hitCorner,1)?0:1,ge=m(e.ANALOG.hitCorner,0)?0:1;xe.text(h),we.text(fe),Ie.text(de),Be.text(ge),h==0?t[21].style.background=a.tr_red:t[21].style.background=a.tr_green,fe==0?t[22].style.background=a.tr_red:t[22].style.background=a.tr_green,de==0?t[23].style.background=a.tr_red:t[23].style.background=a.tr_green,ge==0?t[24].style.background=a.tr_red:t[24].style.background=a.tr_green}l==8&&(x?e.ANALOG.corner==0&&(l=9,g.close(),ce(),oe(r.getMessage("dialogTestSprayNotice"))):e.ANALOG.corner==15&&(l=9,g.close(),ce(),oe(r.getMessage("dialogTestSprayNotice"))))})}function Je(){const t=$(".cf_table tbody").find("tr");j&&(n.send_message(o.MSP_ANALOG,!1,!1,function(){if(he.text(e.ANALOG.leftMotorAdc),ye.text(e.ANALOG.rightMotorAdc),Ce.text(e.ANALOG.fanAdc),e.ANALOG.leftMotorAdc<3100&&e.ANALOG.leftMotorAdc>2500?t[0].style.background=a.tr_green:t[0].style.background=a.tr_red,e.ANALOG.rightMotorAdc<3100&&e.ANALOG.rightMotorAdc>2500?t[1].style.background=a.tr_green:t[1].style.background=a.tr_red,e.CONFIG.hw==1?O?e.ANALOG.fanAdc>500?t[2].style.background=a.tr_green:t[2].style.background=a.tr_red:e.ANALOG.fanAdc<100?t[2].style.background=a.tr_green:t[2].style.background=a.tr_red:e.ANALOG.fanAdc<3100&&e.ANALOG.fanAdc>2500?t[2].style.background=a.tr_green:t[2].style.background=a.tr_red,l==6){if(T==0)if(b>=Z){if(ne(e.ANALOG.leftMotorAdc,e.ANALOG.rightMotorAdc)){se=k(G),le=k(R),e.CONFIG.hw==1&&(O?e.ANALOG.fanAdc>500?t[2].style.background=a.tr_green:t[2].style.background=a.tr_red:e.ANALOG.fanAdc<100?t[2].style.background=a.tr_green:t[2].style.background=a.tr_red);let d="";C&&(d+=r.getMessage("leftWheelError")),M&&(d+=" ",d+=r.getMessage("rightWheelError")),d.length>0?(l=0,T=-1,g.close(),S(d)):(T=1,b=0,X?n.send_message(o.MSP_SET_MOTOR,[1],!1,function(){b=1}):n.send_message(o.MSP_SET_MOTOR,[2],!1,function(){b=1}))}}else s.sampleWheel=0,b++;else if(T==1)if(b>=Z){if(ne(e.ANALOG.leftMotorAdc,e.ANALOG.rightMotorAdc)){let d=k(G),u=k(R),w=se-d,I=le-u;w>=5&&w<=40?C=!1:C=!0,I>=5&&I<=40?M=!1:M=!0,e.CONFIG.hw==1&&(O?e.ANALOG.fanAdc>500?t[2].style.background=a.tr_green:t[2].style.background=a.tr_red:e.ANALOG.fanAdc<100?t[2].style.background=a.tr_green:t[2].style.background=a.tr_red);let h="";C&&(h+=r.getMessage("leftWheelError")+e.ANALOG.leftMotorAdc),M&&(h+=" ",h+=r.getMessage("rightWheelError")+e.ANALOG.rightMotorAdc),h.length>0?(l=0,T=-1,g.close(),S(h),n.send_message(o.MSP_SET_MOTOR,[0],!1,function(){})):(X?T=0:(T=-1,z=!0,D&&(l=8,e.ANALOG.corner==15?(x=!0,q(r.getMessage("dialogTestFourCornerOpenTitle"))):e.ANALOG.corner==0?(x=!1,q(r.getMessage("dialogTestFourCornerCloseTitle"))):(l=0,g.close(),S(r.getMessage("fourCornerError"))))),X=!X,b=0,n.send_message(o.MSP_SET_MOTOR,[0],!1,function(){}))}}else s.sampleWheel=0,b+=1;if(y>=J){if(Te(e.ANALOG.fanAdc))if(!O)re=k(F),E?(l=0,g.close(),S(r.getMessage("fanError"))):D?y=0:n.send_message(o.MSP_SET_FAN,[60],!1,function(){y=0,O=!0});else{let d=k(F),u=re-d;u>=50&&u<=200?E=!1:E=!0,E?(l=0,g.close(),S(r.getMessage("fanError")+u),n.send_message(o.MSP_SET_FAN,[0],!1,function(){O=!1})):(y=0,D=!0,n.send_message(o.MSP_SET_FAN,[0],!1,function(){O=!1,z&&(l=8,e.ANALOG.corner==15?(x=!0,q(r.getMessage("dialogTestFourCornerOpenTitle"))):e.ANALOG.corner==0?(x=!1,q(r.getMessage("dialogTestFourCornerCloseTitle"))):(l=0,g.close(),S(r.getMessage("fourCornerError"))))}))}}else s.sampleFan=0,y++}}),e.CONFIG.hw==2&&n.send_message(o.MSP_BARO,!1,!1,function(){Le.text(r.getMessage("baroValue",[e.SENSOR_DATA.baro])),e.SENSOR_DATA.baro>=1e5&&e.SENSOR_DATA.baro<=12e4?(t[6].style.background=a.tr_green,Q=!1):(t[6].style.background=a.tr_red,Q=!0),l==5&&(Q?(l=0,g.close(),S(r.getMessage("baroError"))):(l=6,T=0,b=0))}),n.send_message(o.MSP_RAW_IMU,!1,!1,function(){Se(e.SENSOR_DATA.gyroscope[0],e.SENSOR_DATA.gyroscope[1],e.SENSOR_DATA.gyroscope[2])&&(L(v)||e.SENSOR_DATA.gyroscope[0]>20||e.SENSOR_DATA.gyroscope[0]<-20?t[12].style.background=a.tr_red:(t[12].style.background=a.tr_green,l==1&&(p+=1)),L(V)||e.SENSOR_DATA.gyroscope[1]>20||e.SENSOR_DATA.gyroscope[1]<-20?t[13].style.background=a.tr_red:(t[13].style.background=a.tr_green,l==1&&(p+=1)),L(W)||e.SENSOR_DATA.gyroscope[2]>20||e.SENSOR_DATA.gyroscope[2]<-20?t[14].style.background=a.tr_red:(t[14].style.background=a.tr_green,l==1&&(p+=1)),l==1&&(l=2)),Oe(e.SENSOR_DATA.accelerometer[0],e.SENSOR_DATA.accelerometer[1],e.SENSOR_DATA.accelerometer[2])&&(L(U)||e.SENSOR_DATA.accelerometer[0]>300||e.SENSOR_DATA.accelerometer[0]<-300?t[15].style.background=a.tr_red:(t[15].style.background=a.tr_green,l==2&&(p+=1)),L(H)||e.SENSOR_DATA.accelerometer[1]>300||e.SENSOR_DATA.accelerometer[1]<-300?t[16].style.background=a.tr_red:(t[16].style.background=a.tr_green,l==2&&(p+=1)),L(Y)||e.SENSOR_DATA.accelerometer[2]<3797||e.SENSOR_DATA.accelerometer[2]>4396?t[17].style.background=a.tr_red:(t[17].style.background=a.tr_green,l==2&&(p+=1)),l==2&&(p==6?e.CONFIG.hw==2?l=3:e.CONFIG.hw==3&&(l=4,ie(r.getMessage("dialogAutoTestAdapterTitle")),n.send_message(o.MSP_ADAPTER,!1,!1,function(){e.ANALOG.adapter>=22&&e.ANALOG.adapter<=26?N=!1:N=!0,N?(l=0,g.close(),S(N)):(ie(r.getMessage("dialogAutoTestWheelTitle")),l=6,T=0,b=Z,C=!1,M=!1,s.sampleWheel=0,z=!1,y=J,s.sampleFan=0,D=!1,E=!1)})):(l=0,g.close(),S(r.getMessage("gyroError"))))),Pe.text(e.SENSOR_DATA.gyroscope[0]),ve.text(e.SENSOR_DATA.gyroscope[1]),Ve.text(e.SENSOR_DATA.gyroscope[2]),We.text(e.SENSOR_DATA.accelerometer[0]),Ue.text(e.SENSOR_DATA.accelerometer[1]),He.text(e.SENSOR_DATA.accelerometer[2])}),n.send_message(o.MSP_BARO_DIFF,!1,!1,function(){Ye.text(e.OVOBOT_FUNCTION.baroOriginal),Xe.text(e.OVOBOT_FUNCTION.baroStandard)}),e.CONFIG.isBattery==1&&($("#batteryval_table").parent().parent().removeClass("model-display"),n.send_message(o.MSP_GET_BATTERY,!1,!1,function(){let d;switch(e.OVOBOT_FUNCTION.batteryStatusVal){case B.BATT_CHG_MODE_NONE:d=r.getMessage("battStatusNone");break;case B.BATT_CHG_MODE_SLOW:d=r.getMessage("battStatusSlow");break;case B.BATT_CHG_MODE_FAST:d=r.getMessage("battStatusFast");break;case B.BATT_CHG_MODE_CONST_VOLT:d=r.getMessage("battStatusConstVolt");break;case B.BATT_CHG_MODE_FULL:d=r.getMessage("battStatusFull");break;default:d=r.getMessage("battStatusUnknown");break}Ze.text(d),Ke.text(e.OVOBOT_FUNCTION.batteryVoltageVal+" V"),je.text(e.OVOBOT_FUNCTION.batteryCurrentVal+" A")})))}A.interval_add("setup_data_pull_fast",Je,50,!0),A.interval_add("setup_data_pull_slow",qe,250,!0),A.content_ready(P)}};ae.cleanup=function(P){this.model&&($(window).off("resize",$.proxy(this.model.resize,this.model)),this.model.dispose()),P&&P()};ue.setup=ae;export{ae as setup};
