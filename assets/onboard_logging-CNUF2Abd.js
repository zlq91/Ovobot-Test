import{G as b,C as N,M as i,X as r,H as h,F as e,a2 as L,a3 as c,$ as a,I as l,D as u,a5 as ee,ad as ae,T as se,g as G,N as z,a0 as A,L as y}from"./DarkTheme-DoxdKMtD.js";import{g as oe}from"./generate_filename-BIkfQQdx.js";import{D as m}from"./debug-DOq7e_Bu.js";import{i as te}from"./main-CAeNTcHC.js";import{s as ne}from"./sensor_types-si-2A0he.js";let S;const R={blockSize:128,writeError:!1,BLOCK_SIZE:4096};R.initialize=function(p){const _=this;let C,E;b.active_tab!=="onboard_logging"&&(b.active_tab="onboard_logging"),N.connectionValid&&i.send_message(r.MSP_FEATURE_CONFIG,!1,!1,function(){i.send_message(r.MSP_DATAFLASH_SUMMARY,!1,!1,function(){i.send_message(r.MSP_SDCARD_SUMMARY,!1,!1,function(){i.send_message(r.MSP_BLACKBOX_CONFIG,!1,!1,function(){i.send_message(r.MSP_ADVANCED_CONFIG,!1,!1,function(){h.gte(e.CONFIG.apiVersion,L)?i.send_message(r.MSP2_GET_TEXT,c.crunch(r.MSP2_GET_TEXT,r.CRAFT_NAME),!1,k):i.send_message(r.MSP_NAME,!1,!1,k)})})})})});function O(s,o){return o===0?s:O(o,s%o)}function k(){a("#content").load("./tabs/onboard_logging.html",function(){l.localizePage();const s=e.DATAFLASH.totalSize>0;let o;e.BLACKBOX.supported||e.DATAFLASH.supported||e.FEATURE_CONFIG.features.isEnabled("BLACKBOX")?o="yes":o="no",a(".tab-onboard_logging").addClass("serial-supported").toggleClass("dataflash-supported",e.DATAFLASH.supported).toggleClass("dataflash-present",s).toggleClass("sdcard-supported",e.SDCARD.supported).toggleClass("blackbox-config-supported",e.BLACKBOX.supported).toggleClass("blackbox-supported",o==="yes").toggleClass("blackbox-maybe-supported",o==="maybe").toggleClass("blackbox-unsupported",o==="no"),s&&(a(".tab-onboard_logging a.erase-flash").click(W),a(".tab-onboard_logging a.erase-flash-confirm").click(j),a(".tab-onboard_logging a.erase-flash-cancel").click(J),a(".tab-onboard_logging a.save-flash").click(q),a(".tab-onboard_logging a.save-flash-cancel").click(U),a(".tab-onboard_logging a.save-flash-dismiss").click(M));const t=a(".blackboxDevice select"),n=a(".blackboxRate select"),g=a(".blackboxDebugMode select"),f=a(".blackboxDebugFields select");e.BLACKBOX.supported&&a(".tab-onboard_logging a.save-settings").on("click",async function(){if(h.gte(e.CONFIG.apiVersion,L)){let d=0;a(".blackboxDebugFields select option:not(:selected)").each(function(){d|=1<<a(this).val()}),e.BLACKBOX.blackboxDisabledMask=d}e.BLACKBOX.blackboxSampleRate=parseInt(n.val(),10),e.BLACKBOX.blackboxPDenom=parseInt(n.val(),10),e.BLACKBOX.blackboxDevice=parseInt(t.val(),10),await i.promise(r.MSP_SET_BLACKBOX_CONFIG,c.crunch(r.MSP_SET_BLACKBOX_CONFIG)),e.PID_ADVANCED_CONFIG.debugMode=parseInt(g.val()),await i.promise(r.MSP_SET_ADVANCED_CONFIG,c.crunch(r.MSP_SET_ADVANCED_CONFIG)),c.writeConfiguration(!0)}),K(n),H(t),$(g),V(f),t.change(function(){a(this).val()==="0"?a("div.blackboxRate").hide():a("div.blackboxRate").show()}).change(),(e.SDCARD.supported&&t.val()==2||e.DATAFLASH.supported&&t.val()==1)&&(a(".tab-onboard_logging").toggleClass("msc-supported",!0),a("a.onboardLoggingRebootMsc").click(function(){u.sendEvent(u.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"RebootMsc");const d=[];b.operating_system==="Linux"?d.push(c.REBOOT_TYPES.MSC_UTC):d.push(c.REBOOT_TYPES.MSC),i.send_message(r.MSP_SET_REBOOT,d,!1)})),F(),b.content_ready(p)})}function H(s){s.empty(),s.append(`<option value="0">${l.getMessage("blackboxLoggingNone")}</option>`),e.DATAFLASH.supported&&s.append(`<option value="1">${l.getMessage("blackboxLoggingFlash")}</option>`),e.SDCARD.supported&&s.append(`<option value="2">${l.getMessage("blackboxLoggingSdCard")}</option>`),s.append(`<option value="3">${l.getMessage("blackboxLoggingSerial")}</option>`),h.gte(e.CONFIG.apiVersion,ee)&&e.SENSOR_CONFIG_ACTIVE.gyro_hardware==ne().gyro.elements.indexOf("VIRTUAL")&&s.append(`<option value="4">${l.getMessage("blackboxLoggingVirtual")}</option>`),s.val(e.BLACKBOX.blackboxDevice)}function K(s){const o=e.CONFIG.sampleRateHz/e.PID_ADVANCED_CONFIG.pid_process_denom,t=5;for(let n=0;n<t;n++){let g=Math.round(o/2**n),f="Hz";O(g,1e3)===1e3&&(g/=1e3,f="kHz"),s.append(`<option value="${n}">1/${2**n} (${g}${f})</option>`)}s.val(e.BLACKBOX.blackboxSampleRate)}function $(s){a(".blackboxDebugMode").show();for(let o=0;o<e.PID_ADVANCED_CONFIG.debugModeCount;o++)o<m.modes.length?s.append(new Option(m.modes[o],o)):s.append(new Option(l.getMessage("onboardLoggingDebugModeUnknown"),o));s.val(e.PID_ADVANCED_CONFIG.debugMode).select2().sortSelect("NONE")}function V(s){if(h.gte(e.CONFIG.apiVersion,L)){a(".blackboxDebugFields").show();let o=e.BLACKBOX.blackboxDisabledMask;for(let t=0;t<m.enableFields.length;t++){const n=(o&1<<t)===0;s.append(new Option(m.enableFields[t],t,!1,n))}s.sortSelect().multipleSelect()}else a(".blackboxDebugFields").hide()}function v(s){if(s<1024)return`${Math.round(s)}kB`;const o=s/1024;let t;return o<900?`${o.toFixed(1)}MB`:(t=o/1024,`${t.toFixed(1)}GB`)}function X(s){return s<1024?`${s}B`:v(s/1024)}function D(s,o,t,n,g){o>0?(s.css({width:`${o/t*100}%`,display:"block"}),a("div",s).text((n?`${n} `:"")+(g?v(o):X(o)))):s.css({display:"none"})}a('input[name="expertModeCheckbox"]').on("change",()=>a("a.regular-button.require-msc-supported.save-flash").toggle(te()));function F(){const s=e.DATAFLASH.totalSize>0;D(a(".tab-onboard_logging .dataflash-used"),e.DATAFLASH.usedSize,e.DATAFLASH.totalSize,l.getMessage("dataflashUsedSpace"),!1),D(a(".tab-onboard_logging .dataflash-free"),e.DATAFLASH.totalSize-e.DATAFLASH.usedSize,e.DATAFLASH.totalSize,l.getMessage("dataflashFreeSpace"),!1),D(a(".tab-onboard_logging .sdcard-other"),e.SDCARD.totalSizeKB-e.SDCARD.freeSizeKB,e.SDCARD.totalSizeKB,l.getMessage("dataflashUnavSpace"),!0),D(a(".tab-onboard_logging .sdcard-free"),e.SDCARD.freeSizeKB,e.SDCARD.totalSizeKB,l.getMessage("dataflashLogsSpace"),!0),a("a.regular-button erase-flash, a.regular-button.require-msc-supported.save-flash").toggleClass("disabled",e.DATAFLASH.usedSize===0),a(".tab-onboard_logging").toggleClass("sdcard-error",e.SDCARD.state===i.SDCARD_STATE_FATAL).toggleClass("sdcard-initializing",e.SDCARD.state===i.SDCARD_STATE_CARD_INIT||e.SDCARD.state===i.SDCARD_STATE_FS_INIT).toggleClass("sdcard-ready",e.SDCARD.state===i.SDCARD_STATE_READY);const o=s||e.SDCARD.state===i.SDCARD_STATE_READY;a(".tab-onboard_logging").toggleClass("msc-not-ready",!o),o?a("a.onboardLoggingRebootMsc").removeClass("disabled"):a("a.onboardLoggingRebootMsc").addClass("disabled");let t;switch(e.SDCARD.state){case i.SDCARD_STATE_NOT_PRESENT:a(".sdcard-status").text(l.getMessage("sdcardStatusNoCard")),t="SdCard: NotPresent";break;case i.SDCARD_STATE_FATAL:a(".sdcard-status").html(l.getMessage("sdcardStatusReboot")),t="SdCard: Error";break;case i.SDCARD_STATE_READY:a(".sdcard-status").text(l.getMessage("sdcardStatusReady")),t="SdCard: Ready";break;case i.SDCARD_STATE_CARD_INIT:a(".sdcard-status").text(l.getMessage("sdcardStatusStarting")),t="SdCard: Init";break;case i.SDCARD_STATE_FS_INIT:a(".sdcard-status").text(l.getMessage("sdcardStatusFileSystem")),t="SdCard: FsInit";break;default:a(".sdcard-status").text(l.getMessage("sdcardStatusUnknown",[e.SDCARD.state]))}s&&e.SDCARD.state===i.SDCARD_STATE_NOT_PRESENT&&(t="Dataflash"),u.sendEvent(u.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"DataLogging",{logSize:e.DATAFLASH.usedSize,logStatus:t}),e.SDCARD.supported&&!S&&(S=setTimeout(function(){S=!1,N.connectionValid&&i.send_message(r.MSP_SDCARD_SUMMARY,!1,!1,function(){F()})},2e3))}function U(){C=!0}function Y(){a(".dataflash-saving progress").attr("value",0),C=!1,a(".dataflash-saving").removeClass("done"),a(".dataflash-saving")[0].showModal()}function M(){a(".dataflash-saving")[0].close()}function I(s,o,t){u.sendEvent(u.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"SaveDataflash");const n=(new Date().getTime()-s)/1e3;console.log(`Received ${o} bytes in ${n.toFixed(2)}s (${(o/n/1024).toFixed(2)}kB / s) with block size ${_.blockSize}.`),isNaN(t)||console.log("Compressed into",t,"bytes with mean compression factor of",o/t),a(".dataflash-saving").addClass("done"),G("showNotifications").showNotifications&&z.showNotification("Ovobot Configurator",{body:l.getMessage("flashDownloadDoneNotification"),icon:"/images/pwa/favicon.ico"})}function B(s){i.send_message(r.MSP_DATAFLASH_SUMMARY,!1,!1,function(){F(),s&&s()})}function q(){b.connected_to&&(_.blockSize=_.BLOCK_SIZE,B(function(){const s=e.DATAFLASH.usedSize;let o;Z(function(t){let n=0,g=0;Y();function f(P,T,w){if(T!==null)if(T.byteLength>0){n+=T.byteLength,isNaN(w)||isNaN(g)?g=null:g+=w,a(".dataflash-saving progress").attr("value",n/s*100);const Q=new Blob([T]);A.writeChunck(o,Q).then(()=>{C||n>=s?(C?M():I(d,n,g),A.closeFile(o)):_.writeError?(M(),A.closeFile(o)):c.dataflashRead(n,_.blockSize,f)})}else I(d,n,g),A.closeFile(o);else c.dataflashRead(n,_.blockSize,f)}const d=new Date().getTime();A.openFile(t).then(P=>{o=P,c.dataflashRead(n,_.blockSize,f)})})}))}function Z(s){const o="BLACKBOX_LOG",t="BBL",n=oe(o,t);A.pickSaveFile(n,l.getMessage("fileSystemPickerFiles",{typeof:t}),`.${t}`).then(g=>{console.log("File picked:",g),s(g)}).then(()=>{console.log("FINISHED")}).catch(g=>{console.error("Error saving blackbox file:",g),y(l.getMessage("dataflashFileWriteFailed")),y(`<strong><span class="message-negative">${l.getMessage("error",{errorMessage:g})}</span class="message-negative></strong>`)})}function W(){E=!1,a(".dataflash-confirm-erase").removeClass("erasing"),a(".dataflash-confirm-erase")[0].showModal()}function x(){B(function(){N.connectionValid&&!E&&(e.DATAFLASH.ready?(a(".dataflash-confirm-erase")[0].close(),G("showNotifications").showNotifications&&z.showNotification("Ovobot Configurator",{body:l.getMessage("flashEraseDoneNotification"),icon:"/images/pwa/favicon.ico"})):setTimeout(x,500))})}function j(){a(".dataflash-confirm-erase").addClass("erasing"),i.send_message(r.MSP_DATAFLASH_ERASE,!1,!1,x)}function J(){E=!0,a(".dataflash-confirm-erase")[0].close()}};R.cleanup=function(p){S&&(clearTimeout(S),S=!1),p&&p()};R.mscRebootFailedCallback=function(){a(".tab-onboard_logging").toggleClass("msc-supported",!1),ae(l.getMessage("operationNotSupported"))};se.onboard_logging=R;export{R as onboard_logging};
